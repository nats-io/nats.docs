# Служба Windows

Сервер NATS поддерживает запуск как служба Windows. Более того, это рекомендуемый способ запуска NATS на Windows. Установщика сейчас нет; пользователи должны использовать `sc.exe`, чтобы установить службу:

```shell
sc.exe create nats-server binPath= "%NATS_PATH%\nats-server.exe [nats-server flags]"
sc.exe start nats-server
```

Команды выше создают и запускают службу `nats-server`. Обратите внимание: флаги nats-server нужно указывать при создании службы. Это позволяет запускать несколько конфигураций NATS на одном Windows‑сервере, используя отношение 1:1 «служба на каждый установленный сервер NATS». После запуска службы ее можно контролировать через `sc.exe` или `nats-server.exe --signal`:

```shell
REM Reload server configuration
nats-server.exe --signal reload

REM Reopen log file for log rotation
nats-server.exe --signal reopen

REM Stop the server
nats-server.exe --signal stop
```

Эти команды по умолчанию управляют службой `nats-server`. Если служба называется иначе, это можно указать:

```shell
nats-server.exe --signal stop=<service name>
```

Полный список сигналов см. в [сигналах процесса](../nats_admin/signals.md).

## Права доступа

Пользователь по умолчанию в примере выше — `System`, у которого есть локальные права администратора и доступ на запись почти ко всем файлам на диске.

Если вы изменяете пользователя службы, например на более ограниченный `NetworkService`, убедитесь, что выставили нужные права. Серверу как минимум нужен доступ на чтение конфигурационного файла и, при использовании JetStream, доступ на запись в каталог хранилища JetStream.

```shell
sc config "nats-server" obj= "NT AUTHORITY\NetworkService" password= ""
```

Если файл логов не настроен, nats-server пишет логи в консоль по умолчанию. Логирование в консоль разрешено не для всех пользователей (например, не для NetworkService).

{% hint style="info" %}
Чтобы упростить отладку, рекомендуется запускать службу NATS с явным файлом логов и внимательно проверять права на запись для настроенного пользователя.
{% endhint %}

```shell
sc.exe create nats-server binPath= "%NATS_PATH%\nats-server.exe --log C:\temp\nats-server.log [other flags]"
```

## Специфичные настройки службы Windows

### Переменная окружения `NATS_STARTUP_DELAY`

Система служб Windows требует связи с программами, работающими как службы. Один из важных сигналов — начальный сигнал «ready», где программа сообщает Windows, что она запущена и работает как ожидается.

По умолчанию `nats-server` дает себе до 10 секунд, чтобы отправить этот сигнал.
Если сервер не готов за это время, он сигнализирует об ошибке запуска.
Задержку можно изменить, установив переменную окружения `NATS_STARTUP_DELAY` в подходящую длительность (например, "20s" для 20 секунд, "1m" для одной минуты).

**Обратите внимание**
* Чтобы переменная `NATS_STARTUP_DELAY` была доступна службе NATS, рекомендуется задавать ее как SYSTEM‑переменную.
* `NATS_STARTUP_DELAY=30s` заставит NATS ждать **до 30 секунд**, но сообщит о состоянии RUNNING, как только сервер будет готов принимать соединения. Чтобы **проверить** увеличенный таймаут запуска, возможно, нужно замедлить старт сервера, например, используя очень большой stream (десятки ГБ) или размещая хранилище JetStream на медленном сетевом устройстве.

Это может быть нужно в случаях, когда NATS корректно запускается из командной строки, но ему требуется больше 10 секунд, чтобы восстановить состояние JetStream‑потоков и подключиться к peers кластера.

# Шифрование данных на диске

*Поддерживается начиная с NATS server версии 2.3.0*

*TPM поддерживается в Windows начиная с NATS Server версии 2.11.0*

{% hint style="warning" %}
Обратите внимание: хотя шифрование данных на диске в NATS server полностью поддерживается, мы рекомендуем использовать шифрование файловой системы, где это доступно.

Шифрование файловой системы, особенно предоставляемое облачными сервисами, оптимизировано по производительности, не создает нагрузки на NATS server и устраняет необходимость управления секретами в установке NATS.

{% endhint %}

NATS server можно настроить на шифрование блоков сообщений, включая заголовки и payload. Также шифруются другие файлы метаданных, такие как файл метаданных stream и файлы метаданных consumer.

Сейчас поддерживаются два варианта шифров:

- `chachapoly` — [ChaCha20-Poly1305](https://pkg.go.dev/golang.org/x/crypto/chacha20poly1305)
- `aes` — [AES-GCM](https://pkg.go.dev/crypto/aes)

Включение шифрования выполняется через блок [конфигурации `jetstream`](/running-a-nats-service/configuration/README.md#jetstream) на сервере.

```text
jetstream : {
  cipher: chachapoly
  key : "6dYfBV0zzEkR3vxZCNjxmnVh/aIqgid1"
}
```

Рекомендуется передавать ключ шифрования через переменную окружения во время запуска, например `$JS_KEY`, чтобы ключ не сохранялся в файле.

```text
jetstream : {
  cipher: chachapoly
  key: $JS_KEY
}
```

Переменную можно экспортировать в окружение или передать при старте сервера.

```shell
JS_KEY="mykey" nats-server -c js.conf
```

## Использование TPM (только Windows)

````
jetstream {
  store_dir: nats
  max_file_store: 10G
  tpm {
          keys_file: "keys"
          encryption_password: "pwd"
  }
}
````
| Свойство                  | Описание                                                                                                                                                                               | По умолчанию           | Версия |
| :------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------- | :------ |
| `keys_file`                     |  Задает файл, в котором хранятся ключи шифрования. Эта опция обязательна, иначе TPM не будет активен. Если файл НЕ СУЩЕСТВУЕТ, новый ключ будет динамически создан и сохранен в `pcr`  | требуется | 2.11.0  |
| `encryption_password`           | Пароль для расшифровки данных в файле ключей. ИЛИ пароль для запечатывания динамически созданного ключа в хранилище TPM. | требуется  | 2.11.0  |
| `srk_password`                  | Пароль Storage Root Key (SRK) используется для доступа к корневому ключу хранения TPM. Пароль srk опционален в TPM 2.0. | не задан  | 2.11.0  |
| `pcr`                           | Platform Configuration Registers (PCR). 0–16 зарезервированы. Выберите значение от 17 до 23. |  22  | 2.11.0  | 
| `cipher`                        |   `chacha`/`chachapoly` или `aes`.                    | `chachapoly` | 2.11.0  |  


## Изменение настроек шифрования

### Включение при наличии существующих данных

Включение шифрования на сервере с существующими данными поддерживается. Учтите, что уже существующие незашифрованные блоки сообщений не будут перешифрованы, однако все новые блоки, которые будут сохранены, _будут_ шифроваться далее.

Если нужно зашифровать существующие блоки, stream можно бэкапить и восстановить (при бэкапе происходит расшифровка, а при восстановлении — повторное шифрование).


### Отключение или изменение ключа

Если шифрование было включено, а сервер перезапущен с другим ключом или вовсе без шифрования, сервер не сможет расшифровать сообщения при загрузке из хранилища. В этом случае в логах будут сообщения примерно такого вида:

```text
Error decrypting our stream metafile: chacha20poly1305: message authentication failed
```

Обратите внимание: это повлияет на функциональность JetStream, но сервер по‑прежнему будет поддерживать функциональность core NATS.

### Изменение шифра

Можно изменить `cipher`, но при этом нужно использовать тот же ключ. Сервер корректно зашифрует новые блоки сообщений новым шифром и расшифрует существующие блоки сообщений старым шифром.

## Производительность

Как и ожидалось, шифрование снижает производительность, но насколько именно — трудно оценить. В некоторых тестах производительности на MacbookPro 2.8 GHz Intel Core i7 с SSD мы наблюдали снижение от 1% до более чем 30%. Помимо CPU‑циклов на шифрование, зашифрованные файлы могут быть больше, что приводит к большему объему записываемых и читаемых данных.

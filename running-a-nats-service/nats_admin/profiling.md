# Профилирование NATS

При исследовании и отладке проблем производительности NATS Server (например, неожиданно высокой загрузки CPU или RAM) может понадобиться собрать и предоставить профили вашей установки для диагностики. Эти профили критичны, чтобы понять, где расходуются CPU‑время и память.

Обратите внимание, профилирование — это продвинутая операция и предназначена только для целей разработки. Операторам серверов следует использовать [порт мониторинга](/running-a-nats-service/nats_admin/monitoring) для повседневной статистики выполнения.

### Через NATS CLI

NATS CLI может запрашивать профили у NATS Server **только при подключении к system account**. Профили по умолчанию записываются в текущий рабочий каталог в виде файлов; их можно отправлять дальше или анализировать с помощью [`go tool pprof`](https://pkg.go.dev/net/http/pprof).

#### Профиль памяти

Селекторы `--name`, `--tags` и `--cluster` можно использовать по отдельности или совместно, чтобы запрашивать профили у конкретных серверов. Профили памяти возвращаются мгновенно. Примеры:

| Команда                                                    | Описание                                                                                   |
|------------------------------------------------------------|--------------------------------------------------------------------------------------------|
| `nats server request profile allocs`                       | Запрос профиля памяти со всех серверов в системе                                            |
| `nats server request profile allocs ./profiles`            | Запрос профиля памяти со всех серверов и запись в каталог `profiles`                        |
| `nats server request profile allocs --name=servername1`    | Запрос профиля памяти только с `servername1`                                                |
| `nats server request profile allocs --tags=aws`            | Запрос профиля памяти со всех серверов с тегом `aws`                                        |
| `nats server request profile allocs --cluster=aws-useast2` | Запрос профиля памяти только со всех серверов кластера `aws-useast2`                         |

#### Профиль CPU

Селекторы `--name`, `--tags` и `--cluster` можно использовать по отдельности или совместно, чтобы запрашивать профили у конкретных серверов. Опция `--timeout` также может использоваться для указания длительности CPU‑профиля. По умолчанию — 5 секунд. Примеры:

| Команда                                                    | Описание                                                                                |
|------------------------------------------------------------|-----------------------------------------------------------------------------------------|
| `nats server request profile cpu`                          | Запрос CPU‑профиля со всех серверов в системе                                           |
| `nats server request profile cpu ./profiles`               | Запрос CPU‑профиля со всех серверов и запись в каталог `profiles`                       |
| `nats server request profile cpu --timeout=10s`            | Запрос CPU‑профиля со всех серверов за 10 секунд                                        |
| `nats server request profile cpu --name=servername1`       | Запрос CPU‑профиля только с `servername1`                                               |
| `nats server request profile cpu --tags=aws`               | Запрос CPU‑профиля со всех серверов с тегом `aws`                                       |
| `nats server request profile cpu --cluster=aws-useast2`    | Запрос CPU‑профиля только со всех серверов кластера `aws-useast2`                        |

### Через порт профилирования

{% hint style="warning" %}
`nats-server` не имеет аутентификации/авторизации для endpoint профилирования. Если вы планируете открыть `nats-server` в интернет, убедитесь, что порт профилирования не экспонируется. По умолчанию профилирование привязывается ко всем интерфейсам `0.0.0.0`, поэтому рассмотрите настройку profiling на `localhost` или соответствующие правила firewall.
{% endhint %}

NATS Server может открыть HTTP‑порт профилирования `pprof`, но его нужно включить, указав `prof_port` в конфигурационном файле NATS Server. Обратите внимание: порт профилирования не аутентифицирован и не должен быть доступен клиентам, интернету и т. п. Например, чтобы включить профилирование на TCP/65432:

```
prof_port = 65432
```

Обратите внимание: эта опция не поддерживает [перезагрузку конфигурации](../configuration/#configuration-reloading), поэтому сервер нужно перезапустить, чтобы изменения вступили в силу.  

После включения порта профилирования можно скачать профили, как описано ниже. Их можно анализировать с помощью [`go tool pprof`](https://pkg.go.dev/net/http/pprof).  

Чтобы увидеть все доступные профили, откройте [http://localhost:65432/debug/pprof/](http://localhost:65432/debug/pprof/)

#### Профиль памяти

`http://localhost:65432/debug/pprof/allocs`

Этот endpoint возвращает ответ мгновенно.

Например, чтобы скачать профиль аллокаций с NATS, запущенного на той же машине:

```shell
curl -o mem.prof http://localhost:65432/debug/pprof/allocs
```

Профиль сохранится в `mem.prof`.

#### Профиль CPU

`http://localhost:65432/debug/pprof/profile?seconds=30`

Этот endpoint блокируется на указанное время, затем возвращает результат. Можно изменить длительность, настроив `?seconds=` в URL, если нужно выбрать более короткий или длинный интервал.

Например, чтобы скачать CPU‑профиль с NATS на той же машине с окном 30 секунд:

```shell
curl -o cpu.prof http://localhost:65432/debug/pprof/profile?seconds=30
```

Профиль сохранится в `cpu.prof`.

# Логирование

## Настройка логирования

Сервер NATS предоставляет различные варианты логирования, которые можно задать через командную строку или конфигурационный файл.

### Опции командной строки

Поддерживаются следующие операции логирования:

```
-l, --log FILE                   Файл для перенаправления вывода логов.
-T, --logtime                    Временные метки в логах (по умолчанию true).
-s, --syslog                     Включить syslog как метод логирования.
-r, --remote_syslog              Адрес syslog‑сервера.
-D, --debug                      Включить отладочный вывод.
-V, --trace                      Трассировка «сырого» протокола.
-VV                              Подробная трассировка (включая системный аккаунт)
-DV                              Отладка и трассировка.
-DVV                             Отладка и подробная трассировка (включая системный аккаунт)
```

#### Отладка и трассировка

Флаг `-DV` включает трассировку и отладку сервера.

```bash
nats-server -DV -m 8222 -user foo -pass bar
```

#### Перенаправление логов в файл

```bash
nats-server -DV -m 8222 -l nats.log
```

#### Временные метки

Если `-T false`, то записи в логах не получают временные метки. По умолчанию — true.

#### Syslog

Вы можете настроить syslog с `UDP`:

```bash
nats-server -r udp://localhost:514
```

или `syslog:`

```bash
nats-server -r syslog://<hostname>:<port>
```

Например:

```bash
syslog://logs.papertrailapp.com:26900
```

### Использование конфигурационного файла

Все эти настройки доступны и в конфигурационном файле.

```
debug:   false
trace:   true
logtime: false
logfile_size_limit: 1GB
logfile_max_num: 100
log_file: "/tmp/nats-server.log"
```

### Ротация логов

Начиная с NATS Server v2.1.4, NATS поддерживает авто‑ротацию логов, когда размер файла превышает лимит `logfile_size_limit`. Бэкап‑файлы имеют то же имя, что и исходный лог, с суффиксом `.yyyy.mm.dd.hh.mm.ss.micros`.

Также можно использовать встроенные механизмы NATS вместе с [logrotate](https://github.com/logrotate/logrotate) — простой стандартной утилитой Linux для ротации логов, доступной в большинстве дистрибутивов (Debian, Ubuntu, RedHat (CentOS) и т. п.), чтобы упростить ротацию.

Например, можно настроить `logrotate` так:

```
/path/to/nats-server.log {
    daily
    rotate 30
    compress
    missingok
    notifempty
    postrotate
        kill -SIGUSR1 `cat /var/run/nats-server.pid`
    endscript
}
```

Первая строка задает путь, к которому применяются последующие строки.

Остальная часть файла указывает, что логи ротируются ежедневно (опция "daily") и что сохраняются 30 более старых копий (опция "rotate"). Другие опции описаны в [документации logrotate](https://linux.die.net/man/8/logrotate).

Раздел "postrotate" говорит серверу NATS перечитать файлы логов после завершения ротации. Команда `` `kill -SIGUSR1 ``cat /var/run/nats-server.pid\`
`` не завершает процесс nats-server, а отправляет сигнал, заставляющий его перечитать файлы логов. Это приведет к записи новых запросов в обновленный лог‑файл.

Файл `/var/run/nats-server.pid` — это место, где NATS server хранит pid master‑процесса.

## Некоторые замечания о логировании

* Сервер NATS в подробном режиме логирует получение сообщений `UNSUB`, но это не означает, что подписка уже удалена, а лишь что сообщение получено. По сообщению `DELSUB` в логе можно определить, когда фактическое удаление подписки завершилось.

# Кластеризация

## Кластеризация сервера NATS

NATS поддерживает запуск каждого сервера в кластерном режиме. Вы можете объединять серверы в кластер для высоконагруженных систем обмена сообщениями, устойчивости и высокой доступности.

Серверы NATS достигают этого, обмениваясь (gossip) информацией и подключаясь ко всем серверам, которые они знают, динамически формируя полносвязную сеть. После того как клиенты [подключаются](../../../using-nats/developing-with-nats/connecting/cluster.md) или [переподключаются](/using-nats/developing-with-nats/reconnect) к конкретному серверу, они получают информацию о текущих участниках кластера. Благодаря этому кластер может расти, сокращаться и само‑восстанавливаться. Полносвязность не обязательно конфигурировать явно.

Обратите внимание: у кластерных серверов NATS есть ограничение пересылки на один хоп. Это означает, что каждый `nats-server` будет пересылать сообщения **только** полученные **от клиента** на соседние `nats-server`, к которым у него есть маршруты. Сообщения, полученные **по маршруту**, распространяются только локальным клиентам.

Чтобы кластер успешно сформировал полносвязную сеть и NATS работал как описано в документации (временно‑ошибочные ситуации исключая), необходимо, чтобы серверы могли подключаться друг к другу, а клиенты — к каждому серверу в кластере.

## URL кластера

Помимо порта для клиентов, `nats-server` слушает «кластерный» URL (опция `-cluster`). Другие `nats-server` могут добавить этот URL в аргумент `-routes`, чтобы войти в кластер. Эти опции можно задавать и в [конфигурационном файле](cluster_config.md), но для простоты в этом обзоре показана только командная строка.

## Простой кластер

Пример простого кластера на одной машине:

Server A — «seed server»

```bash
nats-server -p 4222 -cluster nats://localhost:4248 --cluster_name test-cluster
```

Server B

```shell
nats-server -p 5222 -cluster nats://localhost:5248 -routes nats://localhost:4248 --cluster_name test-cluster
```

Проверьте вывод сервера с выбранными портами клиента и маршрутов.

Server C

```shell
nats-server -p 6222 -cluster nats://localhost:6248 -routes nats://localhost:4248 --cluster_name test-cluster
```

Проверьте вывод сервера с выбранными портами клиента и маршрутов.

У каждого сервера задан порт клиента и порт кластера. Серверы с опцией routes устанавливают маршрут к _seed server_. Поскольку протокол кластеризации распространяет (gossip) участников кластера, все серверы могут обнаруживать другие серверы в кластере. Когда сервер обнаружен, обнаруживший сервер автоматически пытается подключиться к нему, чтобы сформировать _полносвязную сеть_. Обычно на каждой машине запускают только один экземпляр сервера, поэтому можно использовать тот же порт клиента (4222) и порт кластера (4248), и просто указывать маршруты к host/port seed‑сервера.

Аналогично, клиенты, подключенные к любому серверу в кластере, будут обнаруживать другие серверы. Если соединение с сервером прерывается, клиент будет пытаться подключиться ко всем другим известным серверам.

Явной конфигурации для _seed server_ нет. Они просто служат точкой старта для обнаружения серверов другими участниками кластера, а также клиентами. Поэтому это серверы, которые клиенты включают в список URL подключения, а участники кластера — в список routes. Они уменьшают объем конфигурации, так как не каждый сервер должен быть в этих списках. Но способность других серверов и клиентов успешно подключаться зависит от работы _seed server_. Если используется несколько _seed server_, они также используют опцию routes, чтобы установить маршруты друг к другу.

## Опции командной строки

Поддерживаются следующие опции кластеризации:

```text
--routes [rurl-1, rurl-2]     Маршруты для запроса и подключения
--cluster nats://host:port    URL кластера для запросов маршрутов
```

Когда сервер NATS строит маршрут к указанному URL, он объявляет свой кластерный URL всем другим серверам на маршруте, эффективно создавая маршрутизирующую сеть между всеми серверами.

**Примечание:** при использовании `-routes` вы также должны указать `-cluster`.

Кластеризацию можно также настроить через [конфигурационный файл](cluster_config.md).

## Пример кластера из трех серверов

Следующий пример показывает, как запустить кластер из 3 серверов на одном хосте. Начнем с seed‑сервера и используем параметр `-D` для вывода отладочной информации.

```bash
nats-server -p 4222 -cluster nats://localhost:4248 -D
```

Либо можно использовать конфигурационный файл `seed.conf` с таким содержимым:

```text
# Узел‑seed кластера

listen: 127.0.0.1:4222
http: 8222

cluster {
  listen: 127.0.0.1:4248
}
```

И запустить сервер так:

```bash
nats-server -config ./seed.conf -D
```

Это даст вывод примерно такого вида:

```text
[83329] 2020/02/12 16:04:52.369039 [INF] Starting nats-server version 2.1.4
[83329] 2020/02/12 16:04:52.369130 [DBG] Go build version go1.13.6
[83329] 2020/02/12 16:04:52.369133 [INF] Git commit [not set]
[83329] 2020/02/12 16:04:52.369360 [INF] Starting http monitor on 127.0.0.1:8222
[83329] 2020/02/12 16:04:52.369436 [INF] Listening for client connections on 127.0.0.1:4222
[83329] 2020/02/12 16:04:52.369441 [INF] Server id is NDSGCS74MG5ZUMBOVWOUJ5S3HIOW
[83329] 2020/02/12 16:04:52.369443 [INF] Server is ready
[83329] 2020/02/12 16:04:52.369534 [INF] Listening for route connections on 127.0.0.1:4248
```

Можно указать hostname и порт отдельно. Минимально требуется порт. Если hostname не задан, будет привязка ко всем интерфейсам (`0.0.0.0`).

```text
cluster {
  host: 127.0.0.1
  port: 4248
}
```

Теперь запустим еще два сервера, каждый подключается к seed‑серверу.

```bash
nats-server -p 5222 -cluster nats://localhost:5248 -routes nats://localhost:4248 -D
```

При запуске на одном хосте нужно выбрать разные порты для клиентских подключений `-p` и для порта маршрутов `-cluster`. Обратите внимание, что `-routes` указывает на адрес `-cluster` seed‑сервера (`localhost:4248`).

Ниже лог. Видно, как он подключается и регистрирует маршрут к seed‑серверу (`...GzM`).

```text
[83330] 2020/02/12 16:05:09.661047 [INF] Starting nats-server version 2.1.4
[83330] 2020/02/12 16:05:09.661123 [DBG] Go build version go1.13.6
[83330] 2020/02/12 16:05:09.661125 [INF] Git commit [not set]
[83330] 2020/02/12 16:05:09.661341 [INF] Listening for client connections on 0.0.0.0:5222
[83330] 2020/02/12 16:05:09.661347 [INF] Server id is NAABC2CKRVPZBIECMLZZA6L3PK
[83330] 2020/02/12 16:05:09.661349 [INF] Server is ready
[83330] 2020/02/12 16:05:09.662429 [INF] Listening for route connections on localhost:5248
[83330] 2020/02/12 16:05:09.662676 [DBG] Trying to connect to route on localhost:4248
[83330] 2020/02/12 16:05:09.663308 [DBG] 127.0.0.1:4248 - rid:1 - Route connect msg sent
[83330] 2020/02/12 16:05:09.663370 [INF] 127.0.0.1:4248 - rid:1 - Route connection created
[83330] 2020/02/12 16:05:09.663537 [DBG] 127.0.0.1:4248 - rid:1 - Registering remote route "NDSGCS74MG5ZUMBOVWOUJ5S3HIOW"
[83330] 2020/02/12 16:05:09.663549 [DBG] 127.0.0.1:4248 - rid:1 - Sent local subscriptions to route
```

Из лога seed‑сервера видно, что маршрут принят:

```text
[83329] 2020/02/12 16:05:09.663386 [INF] 127.0.0.1:62941 - rid:1 - Route connection created
[83329] 2020/02/12 16:05:09.663665 [DBG] 127.0.0.1:62941 - rid:1 - Registering remote route "NAABC2CKRVPZBIECMLZZA6L3PK"
[83329] 2020/02/12 16:05:09.663681 [DBG] 127.0.0.1:62941 - rid:1 - Sent local subscriptions to route
```

Наконец, запустим третий сервер:

```bash
nats-server -p 6222 -cluster nats://localhost:6248 -routes nats://localhost:4248 -D
```

Снова видим, что используем другой клиентский порт и другой cluster‑адрес, но указываем тот же seed‑сервер `nats://localhost:4248`:

```text
[83331] 2020/02/12 16:05:12.838022 [INF] Listening for client connections on 0.0.0.0:6222
[83331] 2020/02/12 16:05:12.838029 [INF] Server id is NBE7SLUDLFIMHS2U6347N3DQEJ
[83331] 2020/02/12 16:05:12.838031 [INF] Server is ready
...
[83331] 2020/02/12 16:05:12.839203 [INF] Listening for route connections on localhost:6248
[83331] 2020/02/12 16:05:12.839453 [DBG] Trying to connect to route on localhost:4248
[83331] 2020/02/12 16:05:12.840112 [DBG] 127.0.0.1:4248 - rid:1 - Route connect msg sent
[83331] 2020/02/12 16:05:12.840198 [INF] 127.0.0.1:4248 - rid:1 - Route connection created
[83331] 2020/02/12 16:05:12.840324 [DBG] 127.0.0.1:4248 - rid:1 - Registering remote route "NDSGCS74MG5ZUMBOVWOUJ5S3HIOW"
[83331] 2020/02/12 16:05:12.840342 [DBG] 127.0.0.1:4248 - rid:1 - Sent local subscriptions to route
[83331] 2020/02/12 16:05:12.840717 [INF] 127.0.0.1:62946 - rid:2 - Route connection created
[83331] 2020/02/12 16:05:12.840906 [DBG] 127.0.0.1:62946 - rid:2 - Registering remote route "NAABC2CKRVPZBIECMLZZA6L3PK"
[83331] 2020/02/12 16:05:12.840915 [DBG] 127.0.0.1:62946 - rid:2 - Sent local subscriptions to route
```

Сначала создается маршрут к seed‑серверу (`...IOW`), а после этого принимается маршрут от `...3PK` — это ID второго сервера.

Лог seed‑сервера показывает, что он принял маршрут от третьего сервера:

```text
[83329] 2020/02/12 16:05:12.840111 [INF] 127.0.0.1:62945 - rid:2 - Route connection created
[83329] 2020/02/12 16:05:12.840350 [DBG] 127.0.0.1:62945 - rid:2 - Registering remote route "NBE7SLUDLFIMHS2U6347N3DQEJ"
[83329] 2020/02/12 16:05:12.840363 [DBG] 127.0.0.1:62945 - rid:2 - Sent local subscriptions to route
```

А лог второго сервера показывает, что он подключился к третьему.

```text
[83330] 2020/02/12 16:05:12.840529 [DBG] Trying to connect to route on 127.0.0.1:6248
[83330] 2020/02/12 16:05:12.840684 [DBG] 127.0.0.1:6248 - rid:2 - Route connect msg sent
[83330] 2020/02/12 16:05:12.840695 [INF] 127.0.0.1:6248 - rid:2 - Route connection created
[83330] 2020/02/12 16:05:12.840814 [DBG] 127.0.0.1:6248 - rid:2 - Registering remote route "NBE7SLUDLFIMHS2U6347N3DQEJ"
[83330] 2020/02/12 16:05:12.840827 [DBG] 127.0.0.1:6248 - rid:2 - Sent local subscriptions to route
```

На этом этапе кластер серверов NATS полносвязный.

### Тестирование кластера

Далее должно работать следующее: создайте подписку на первом сервере (порт 4222). Затем публикуйте на каждый сервер (порты 4222, 5222, 6222). Вы должны получать сообщения без проблем.

Тестирование сервера A

```bash
nats sub -s "nats://127.0.0.1:4222" hello &
nats pub -s "nats://127.0.0.1:4222" hello world_4222
```

```text
23:34:45 Subscribing on hello
23:34:45 Published 10 bytes to "hello"

[#1] Received on "hello"
world_4222
```

Тестирование сервера B

```shell
nats pub -s "nats://127.0.0.1:5222" hello world_5222
```

```text
[#2] Received on "hello"
23:36:09 Published 10 bytes to "hello"
world_5222
```

Тестирование сервера C

```shell
nats pub -s "nats://127.0.0.1:6222" hello world_6222
```

```text
23:38:40 Published 10 bytes to "hello"
[#3] Received on "hello"
world_6222
```

Тестирование через URL seed‑серверов (т. е. A, B и C)

```shell
nats pub -s "nats://127.0.0.1:4222,nats://127.0.0.1:5222,nats://127.0.0.1:6222" hello whole_world
```

```text
[#4] Received on "hello"
23:39:16 Published 11 bytes to "hello"
whole_world
```

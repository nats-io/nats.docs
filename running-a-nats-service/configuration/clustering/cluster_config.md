# Конфигурация кластеризации

[`cluster` карта конфигурации](../../configuration/README.md#clustering) имеет следующие опции:

| Свойство                           | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Версия |
|------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------|
| `host`                             | Интерфейс, на котором gateway будет слушать входящие route‑соединения.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |         |
| `port`                             | Порт, на котором gateway будет слушать входящие route‑соединения.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |         |
| `name`                             | Имя кластера (рекомендуется для NATS v2.2+)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |         |
| `listen`                           | Объединяет `host` и `port` как `<host>:<port>`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |         |
| `tls`                              | Карта конфигурации [`tls`](/running-a-nats-service/configuration/securing_nats/tls.md) для защиты кластерных соединений. `verify` всегда включен, а `cert_file` используется и для клиента, и для сервера. [См.](/running-a-nats-service/configuration/securing_nats/tls.md#wrong-key-usage) подводные камни сертификатов.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |         |
| `advertise` или `cluster_advertise` | Hostport `<host>:<port>` для объявления того, как другие участники кластера могут связаться с этим сервером. Полезно в конфигурациях с NAT. При использовании TLS это важно, чтобы управлять hostname, который клиенты будут использовать при обнаружении маршрута, так как по умолчанию это будет IP и проверка TLS hostname может упасть из‑за ошибки IP SAN.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |         |
| `no_advertise`                     | Если установлено в `true`, сервер не будет распространять (gossip) свои URL серверов клиентам. Это также отключает `client_advertise` в разделе [общей конфигурации](../README.md). Полное отключение advertise может быть полезным, если сервер доступен через разные балансировщики и интерфейсы из разных сетей. Автоматическое объявление внутреннего IP может приводить к задержкам переподключений из‑за неудачных попыток.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |         |
| `routes`                           | Список других серверов (URL) для объединения в кластер. Self‑routes игнорируются. Если требуется аутентификация через `token` или `username`/`password`, укажите их в URL.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |         |
| `connect_retries`                  | После какого количества неудачных попыток подключения прекратить попытки к обнаруженному route. По умолчанию `0`, не повторять. При включении попытки делаются раз в секунду. Это не применяется к явно заданным routes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |         |
| `connect_backoff`                  | Включить экспоненциальную задержку при попытках переподключения. Если `true`, будет использован backoff от 1 до 30 секунд.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 2.12.0  |
| `authorization`                    | Карта [авторизации](../securing_nats/auth_intro#authorization-map) для настройки кластерных маршрутов. Когда используется один `username`/`password`, это определяет механизм аутентификации, который ожидает этот сервер, и как этот сервер будет аутентифицироваться при установке соединения с _обнаруженным_ route. Это не используется для routes, явно перечисленных в `routes`, поэтому такие учетные данные должны быть частью URL. При этом режиме аутентификации либо используйте одинаковые учетные данные во всей системе, либо перечисляйте каждый route явно на каждом сервере. Если карта `tls` задает `verify_and_map`, указывайте только ожидаемый `username`. Здесь можно использовать разные сертификаты, но они должны сопоставляться с одним и тем же `username`. Карта авторизации также допускает `timeout`, он учитывается, но конфигурации `users` и `token` не поддерживаются и приведут к тому, что сервер не запустится. Блок `permissions` игнорируется. |         |
| `pool_size`                        | Размер пула соединений, используемого для распределения нагрузки между не‑закрепленными аккаунтами. По умолчанию `3`. Подробнее см. [v2 Routes](./v2_routes.md#connection-pooling).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |         |
| `accounts`                         | Опциональный список аккаунтов, для которых будет закреплено route‑соединение. Подробнее см. [v2 Routes](./v2_routes.md#account-pinning).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |         |
| `compression`                      | Режим сжатия, используемый сервером при подключении к peer‑серверам. По умолчанию `accept`. Подробнее см. [v2 Routes](./v2_routes.md#compression).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |         |

```
cluster {
  name: example

  # host/port для входящих route‑соединений от других серверов
  listen: localhost:4244

  # Авторизация route‑соединений
  # Другие серверы могут подключаться, если предоставят указанные учетные данные
  # Этот сервер будет подключаться к обнаруженным routes с этим пользователем
  authorization {
    user: route_user
    password: pwd
    timeout: 0.5
  }

  # Этот сервер устанавливает маршруты с этими серверами.
  # Этот сервер запрашивает новые маршруты и активно подключается к ним.
  # Другие серверы могут подключаться к нам, если предоставят правильные учетные данные
  # в их определениях routes выше.
  routes = [
    nats://route_user:pwd@127.0.0.1:4245
    nats://route_user:pwd@127.0.0.1:4246
  ]
}
```

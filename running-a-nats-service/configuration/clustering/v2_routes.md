# v2 Routes (маршруты)

_Введено в NATS v2.10.0_

## Пулинг соединений

До релиза v2.10.0 два сервера в кластере имели только одно соединение для передачи всех сообщений всех аккаунтов, что могло приводить к замедлению и росту использования памяти, если данные не успевали передаваться достаточно быстро.

Релиз v2.10.0 ввел возможность иметь несколько route‑соединений между двумя серверами. По умолчанию, без изменения конфигурации, кластеризация двух серверов v2.10.0+ создаст 3 route‑соединения. Это значение можно изменить, явно настроив размер пула.

```
cluster {
  pool_size: 3
}
```

### Требования к размеру пула

Каждое из этих соединений обслуживает определенное подмножество аккаунтов, и назначение аккаунта на конкретный индекс соединения в пуле одинаково на всех серверах кластера. Требуется, чтобы каждый сервер в кластере имел одинаковое значение `pool_size`, иначе кластеризация завершится ошибкой вроде:

```
[ERR] 127.0.0.1:6222 - rid:6 - Mismatch route pool size: 3 vs 4
```

### Обработка потери соединения

Если одно из соединений пула разрывается, автоматическое переподключение происходит как обычно. Однако пока идет отключение, трафик аккаунтов, обслуживаемых этим соединением, останавливается (то есть не маршрутизируется через другие соединения), так же как раньше при единственном route‑соединении.

### Перезагрузка конфигурации

Хотя параметр `pool_size` можно изменить через перезагрузку конфигурации, соединения между серверами, скорее всего, будут разорваны из‑за несоответствия значений между серверами. Однако можно выполнить поэтапную (rolling) перезагрузку, задав одинаковое значение на всех серверах. Клиентские и другие соединения (включая выделенные маршруты аккаунтов — см. следующий раздел) не будут закрыты.

### Мониторинг

Когда мониторинг включен, на странице `/routez` будет больше соединений, чем раньше, что ожидаемо.

### Отключение пула соединений

Можно отключить пулинг route‑соединений, установив параметр `pool_size` в значение `-1`. В этом случае сервер будет вести себя как до v2.10.0 и создавать одно route‑соединение между peers.

Учтите, что в этом режиме нельзя задавать список `accounts` (см. раздел "Account pinning" ниже).

## Закрепление аккаунтов (Account pinning)

Кроме пулинга соединений, релиз v2.10.0 ввел возможность задать список аккаунтов, для которых будут выделены отдельные route‑соединения.

```
cluster {
  accounts: [acc1, acc2]
}
```

По умолчанию сервер создаст выделенный route для системного аккаунта (специальной конфигурации не требуется).

Выделенный route улучшает производительность и снижает задержки. Еще одно преимущество: так как route выделен конкретному аккаунту, имя аккаунта не нужно добавлять в протоколы маршрутизации сообщений. Поскольку имена аккаунтов могут быть длинными, это снижает количество передаваемых байтов во всех остальных случаях.

### Обработка потери соединения

Если route‑соединение аккаунта разрывается, автоматическое переподключение происходит как обычно. Однако в момент разрыва трафик этого аккаунта останавливается.

### Перезагрузка конфигурации

Список `accounts` можно менять и отправлять серверу сигнал перезагрузки конфигурации. Все серверы должны иметь одинаковый список, однако можно выполнить rolling‑перезагрузку.

Например, добавление аккаунта в список сервера `A` и перезагрузка конфигурации не приведут к ошибке, даже если другой сервер в кластере еще не имеет этот аккаунт в списке. Выделенное соединение еще не будет установлено, но трафик этого аккаунта в пул‑соединении, которое его обслуживает, будет остановлен. Когда перезагрузка произойдет на другом сервере, выделенное соединение будет установлено и трафик аккаунта возобновится.

При удалении аккаунта из списка и перезагрузке конфигурации соединение для этого аккаунта будет закрыто, и трафик этого аккаунта остановится. Другие серверы, у которых этот аккаунт еще настроен с выделенным соединением, не смогут переподключиться. Когда им также отправят сигнал перезагрузки (с обновленной конфигурацией `accounts`), трафик аккаунта будет обслуживаться соединением из пула.

Обратите внимание, что перезагрузка конфигурации со сменой списка `accounts` не влияет на существующие соединения пула и, следовательно, не должна влиять на трафик других аккаунтов.

### Мониторинг

Когда мониторинг включен, информация о route‑соединении содержит новое поле `account`, показывающее имя аккаунта, для которого это соединение.

### Отключение пула соединений

Как указано в разделе про пулинг, если `pool_size` установлен в `-1`, список `accounts` нельзя настроить и он не будет использоваться.

### Подключение к старому серверу

Хотя рекомендуется, чтобы все серверы в одном кластере были одной версии, сервер v2.10.0 сможет подключиться к более старому серверу и в этом случае создаст одно route‑соединение к этому серверу. Это позволяет легко развернуть v2.10.0 в существующем кластере с более старым релизом.

## Сжатие

Релиз v2.10.0 ввел возможность настраивать сжатие между серверами, имеющими route‑соединения. Текущий алгоритм сжатия — [S2, расширение Snappy](https://github.com/klauspost/compress/tree/master/s2#s2-compression). По умолчанию маршруты не используют сжатие, его нужно явно включить.

```
cluster {
  compression: {
    mode: accept
  }
}
```

### Режимы сжатия

Есть несколько режимов сжатия, и нет требования, чтобы у соединенных серверов были одинаковые режимы.

- `off` — явно отключает сжатие для любых route‑соединений между сервером и peer.
- `accept` (по умолчанию) — не инициирует сжатие, но принимает режим сжатия peer, к которому подключается.
- `s2_fast` — применяет сжатие с оптимизацией скорости, а не степени сжатия.
- `s2_better` — применяет сжатие с балансом скорости и степени сжатия.
- `s2_best` — применяет сжатие с оптимизацией степени сжатия, а не скорости.
- `s2_auto` — выбирает подходящий `s2_*` режим относительно измеренного RTT между сервером и peer. См. `rtt_thresholds` ниже.

### Пороги RTT (round-trip time)

Когда используется `s2_auto`, он опирается на опцию `rtt_thresholds` — список из трех порогов задержки, определяющих увеличение/уменьшение режима сжатия.

```
cluster {
  compression: {
    mode: s2_auto
    rtt_thresholds: [10ms, 50ms, 100ms]
  }
}
```

Значение по умолчанию для `rtt_thresholds` — `[10ms, 50ms, 100ms]`. Это читается так: если RTT меньше 10ms, сжатие не применяется. При достижении 10ms применяется `s2_fast`, и далее по двум порогам — `s2_better` и `s2_best`.

### Перезагрузка конфигурации

Конфигурацию `compression` можно изменить через перезагрузку конфигурации. Если значение меняется с `off` на любое другое, соединения закрываются и пересоздаются — так же, как при выключении сжатия установкой `off`.

Для всех остальных режимов сжатия режим меняется динамически без необходимости закрывать route‑соединения.

### Мониторинг

Когда мониторинг включен, информация о route‑соединении содержит новое поле `compression`, показывающее текущий режим сжатия. Это может быть `off` или любой другой режим, описанный выше. Обратите внимание, что `s2_auto` не отображается — вместо этого отображается _текущий режим_, например `s2_best` или `s2_uncompressed`.

Если подключение идет к старому серверу, поле `compression` будет показывать `not supported`.

### Подключение к старому серверу

Сервер v2.10.0+ с настроенным режимом сжатия может подключиться к старому серверу, который сжатие не поддерживает. Соединение просто не будет использовать сжатие.

# Конфигурация

## Блок конфигурации `leafnodes`

Блок конфигурации leaf‑node используется для настройки входящих и исходящих leaf‑подключений. Большинство свойств относится к входящим подключениям. Свойства `remotes` и `reconnect` — для исходящих подключений.

| Свойство        | Описание                                                                                                                                                                                |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `host`          | Интерфейс, на котором сервер будет слушать входящие leaf‑подключения.                                                                                                                    |
| `port`          | Порт, на котором сервер будет слушать входящие leaf‑подключения (по умолчанию 7422).                                                                                                     |
| `listen`        | Объединяет `host` и `port` как `<host>:<port>`                                                                                                                                           |
| `tls`           | Блок конфигурации TLS (такой же, как в других настройках [`tls` nats-server](/running-a-nats-service/configuration/securing_nats/tls.md)).                                               |
| `advertise`     | Hostport `<host>:<port>`, который будет объявлен leaf‑nodes. Полезно в кластерных настройках с NAT.                                                                                       |
| `no_advertise`  | Если `true`, сервер не должен объявляться leaf‑nodes.                                                                                                                                    |
| `authorization` | Блок авторизации. [**См. раздел Authorization Block ниже**](leafnode_conf.md#authorization-block).                                                                                       |
| `remotes`       | Список записей [`remote`](leafnode_conf.md#leafnode-remotes-entry-block), задающих серверы, к которым можно подключаться как leaf‑client.                                                |
| `reconnect`     | Интервал в секундах между попытками переподключения к удаленному серверу.                                                                                                                |
| `compression`   | Настройка сжатия leaf‑подключений, аналогично [кластерным маршрутам](../clustering/v2_routes.md). По умолчанию `s2_auto`. Подробнее [здесь](../clustering/v2_routes.md#compression).     |

## TLS Block

_Начиная с NATS v2.10.0_

Блок `tls` для конфигурации `leafnodes` имеет дополнительное поле, включающее _TLS‑first handshake_ между удаленным и принимающим сервером.

| Свойство          | Описание                                                                                                                   |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------- |
| `handshake_first` | Если `true` на стороне приема, удаленные leaf‑nodes также должны иметь эту настройку в секции `remotes`.                   |

### Сторона приема

Так как leaf‑nodes могут подключаться к разным серверам, возможность указать, что TLS‑рукопожатие должно выполняться первым, настраивается в двух местах. Сторона _приема_ задается в блоке `tls` внутри блока `leafnodes`.

```
leafnodes {
  port: 7422
  tls {
    handshake_first: true
    # другие поля TLS...
  }
}
```

С этой конфигурацией старый сервер или сервер без `handshake_first: true` в удаленной конфигурации не сможет установить leaf‑подключение, потому что принимающая сторона инициирует TLS‑рукопожатие, а запрашивающая сторона будет ждать INFO‑сообщение протокола.

### Сторона remote

Чтобы указать, что leaf‑подключение должно сначала выполнить TLS‑рукопожатие, это нужно настроить в конфигурации remote:

```
leafnodes {
  remotes [
    {
      urls: ["tls://example:7422"]
      tls: {
         handshake_first: true
         # другие поля TLS...
      }
    }
  ]
}
```

Если remote настроен так, но сервер, к которому он подключается, не имеет `handshake_first: true`, соединение провалится: запрашивающая сторона выполняет TLS‑рукопожатие, но получит INFO‑сообщение протокола в открытом виде.

## Authorization Block

{% hint style="info" %}
Leaf‑node может аутентифицироваться по любому пользователю аккаунта на hub (входящая сторона подключения), включая пользователей, определенных внутри самих аккаунтов. Поэтому этот блок авторизации необязателен, если нужные пользователи аккаунта уже существуют.

Удобнее ли настраивать пользователей в аккаунте или в отдельном блоке авторизации, зависит от вашего стиля развертывания.
{% endhint %}

| Свойство   | Описание                                                                                                                         |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| `user`     | Имя пользователя для leaf‑подключения.                                                                                             |
| `password` | Пароль для записи пользователя.                                                                                                    |
| `account`  | [Аккаунт](../securing_nats/accounts.md), к которому должно быть привязано это leaf‑подключение.                                    |
| `timeout`  | Максимальное число секунд ожидания аутентификации leaf‑подключения.                                                                 |
| `users`    | Список учетных данных и аккаунтов для привязки leaf‑подключений. [**См. раздел Users Block ниже**](leafnode_conf.md#users-block).  |

### Users Block

| Свойство   | Описание                                                                           |
| ---------- | --------------------------------------------------------------------------------- |
| `user`     | Имя пользователя для leaf‑подключения.                                            |
| `password` | Пароль для записи пользователя.                                                   |
| `account`  | [Аккаунт](../securing_nats/accounts.md), к которому должно быть привязано соединение. |

Ниже примеры базовой аутентификации user/password для leaf‑nodes (обратите внимание: используется accounts, но не JWT).

Singleton mode:

```
leafnodes {
  port: ...
  authorization {
    user: leaf
    password: secret
    account: TheAccount
  }
}
```

С этой конфигурацией, если запрашивающий сервер создаст leaf‑подключение с URL `nats://leaf:secret@host:port`, принимающий сервер привяжет leaf‑подключение к аккаунту "TheAccount". Этот аккаунт должен существовать, иначе соединение будет отклонено.

Multi‑users mode:

```
leafnodes {
  port: ...
  authorization {
    users = [
      {user: leaf1, password: secret, account: account1}
      {user: leaf2, password: secret, account: account2}
    ]
  }
}
```

С этой конфигурацией, если сервер подключается как `leaf1:secret@host:port`, принимающий сервер привяжет соединение к аккаунту `account1`. Если использовать пользователя `leaf2`, соединение будет привязано к `account2`.

Если задано username/password (в режиме singleton или multi‑users), подключающийся сервер ДОЛЖЕН предоставить правильные учетные данные, иначе соединение будет отклонено.

Если username/password не указаны, все равно можно указать аккаунт, с которым должно быть связано соединение:

```
leafnodes {
  port: ...
  authorization {
    account: TheAccount
  }
}
```

С этой конфигурацией соединение без учетных данных будет привязано к аккаунту "TheAccount".

Если используются другие формы учетных данных (jwt, nkey и т. п.), сервер попытается аутентифицироваться и, при успехе, свяжет соединение с аккаунтом соответствующего пользователя. Если аутентификация пользователя не удалась (неверный пароль, нет такого пользователя и т. п.), соединение также будет отклонено.

## Блок записей LeafNode `remotes`

| Свойство         | Описание                                                                                                                                                                                                                                                               |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `url`            | Leafnode URL (протокол URL должен быть `nats-leaf`).                                                                                                                                                                                                                    |
| `urls`           | Массив URL leafnode. Поддерживаются несколько URL для обнаружения, например `urls: [ "nats-leaf://host1:7422", "nats-leaf://host2:7422" ]`                                                                                                                        |
| `no_randomize`   | Если true, всегда пытаться подключаться последовательно по списку URL. По умолчанию URL перемешиваются, и попытки начинаются со случайного URL.                                                                                                                        |
| `account`        | Имя [аккаунта](../securing_nats/accounts.md) или публичный ключ JWT, идентифицирующий локальный аккаунт, который будет связан с этим удаленным сервером. Любой локальный трафик на этом аккаунте будет перенаправляться на удаленный сервер.                              |
| `deny_imports`   | Список subject, которые не будут импортироваться через это leaf‑подключение. Подписки на эти subject не будут распространяться на hub.                                                                                                                                    |
| `deny_exports`   | Список subject, которые не будут экспортироваться через это leaf‑подключение. Подписки на эти subject не будут распространяться в leaf‑node.                                                                                                                             |
| `credentials`    | Файл учетных данных для подключения к leaf‑серверу.                                                                                                                                                                                                                      |
| `nkey`           | Nkey для подключения к leaf‑серверу.                                                                                                                                                                                                                                    |
| `tls`            | Блок [TLS‑конфигурации](leafnode_conf.md#tls-configuration-block). Leaf‑клиент будет использовать указанные сертификаты TLS при подключении/аутентификации.                                                                                                               |
| `ws_compression` | Если подключение идет по протоколу [Websocket](leafnode_conf.md#connecting-using-websocket-protocol), этот boolean (`true` или `false`) указывает удаленному серверу, что клиент хочет использовать сжатие. По умолчанию `false`.                                         |
| `ws_no_masking`  | Если подключение идет по протоколу [Websocket](leafnode_conf.md#connecting-using-websocket-protocol), этот boolean указывает удаленному серверу, что клиент не хочет маскировать исходящие WebSocket‑фреймы. По умолчанию `false`, что означает, что исходящие фреймы будут маскированы. |
| `compression`    | Настройка сжатия leaf‑подключений, аналогично [кластерным маршрутам](../clustering/v2_routes.md). По умолчанию `s2_auto`. Подробнее [здесь](../clustering/v2_routes.md#compression).                                                                                    |
| `hub`            | По умолчанию `false`. Если `true`, роли leaf‑node и hub будут поменяны местами. Это позволяет hub инициировать leaf‑подключение к leaf.                                                                                                                                |
| `first_info_timeout` | По умолчанию `1s`. Первое, что отправляет hub (входящая сторона), — метаданные сервера. Клиент будет ждать только `first_info_timeout`, прежде чем сдаться. Это полезно, если есть вероятность, что порт на другой стороне не является сервером NATS или не принимает leaf‑подключения. В этом случае клиент иначе бы ждал метаданные бесконечно. |


### Signature Handler

Начиная с NATS Server v2.9.0, для пользователей, которые встраивают NATS Server, можно заменить использование файла учетных данных коллбеком подписи, который подпишет `nonce` и предоставит JWT в протоколе `CONNECT`. В `RemoteLeafOpts` появилось новое поле:

```go
SignatureCB  SignatureHandler
```

Определение коллбека:

```go
// SignatureHandler is used to sign a nonce from the server while
// authenticating with Nkeys. The callback should sign the nonce and
// return the JWT and the raw signature.
type SignatureHandler func([]byte) (string, []byte, error)
```

Пример использования можно найти [здесь](https://github.com/nats-io/nats-server/blob/7baf7bd8870a0719e3692e6523b09a14653f717d/server/leafnode_test.go#L4402)

### Подключение по протоколу WebSocket

Начиная с NATS 2.2.0, leaf‑nodes поддерживают исходящие WebSocket‑подключения, если указать `ws` как схему в URL удаленного сервера:

```
leafnodes {
  remotes [
    {urls: ["ws://hostname1:443", "ws://hostname2:443"]}
  ]
}
```

Обратите внимание: если URL имеет схему `ws`, все URL в списке должны быть `ws`. Нельзя смешивать. Поэтому такая конфигурация будет считаться некорректной:

```
  remotes [
    # Некорректная конфигурация, которая не даст серверу запуститься
    {urls: ["ws://hostname1:443", "nats://hostname2:7422"]}
  ]
```

Учтите, что решение о TLS‑подключении не основывается на `wss://` (в отличие от `ws://`), а определяется наличием TLS‑конфигурации в `leafnodes{}` или конкретном блоке конфигурации remote.

Чтобы настроить Websocket на удаленном сервере, см. раздел [Websocket](../websocket/).

### Блок конфигурации `tls`

| Свойство            | Описание                                                                                                                |
| ------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| `cert_file`         | Файл TLS‑сертификата.                                                                                                    |
| `key_file`          | Файл ключа TLS‑сертификата.                                                                                              |
| `ca_file`           | Файл центра сертификации TLS.                                                                                            |
| `insecure`          | Пропустить проверку сертификата.                                                                                         |
| `verify`            | Если `true`, требовать и проверять клиентские сертификаты.                                                               |
| `verify_and_map`    | Если `true`, требовать и проверять клиентские сертификаты и использовать значения сертификата для целей аутентификации. |
| `cipher_suites`     | Если задано, разрешены только указанные TLS cipher suites. Значения должны соответствовать версии golang, используемой при сборке сервера. |
| `curve_preferences` | Список TLS‑кривых шифрования в порядке использования.                                                                    |
| `timeout`           | Таймаут TLS‑рукопожатия в дробных секундах.                                                                              |

# Leaf Nodes (листовые узлы)

_Leaf Node_ расширяет существующую систему NATS любого размера, при необходимости связывая как операторские, так и домены безопасности. Leaf‑node сервер прозрачно маршрутизирует сообщения между локальными клиентами и одним или несколькими удаленными NATS‑системами, и наоборот. Leaf‑node аутентифицирует и авторизует клиентов по локальной политике. Сообщения могут идти в кластер или в leaf‑node в зависимости от разрешений подключения leaf‑node с любой стороны.

Leaf‑nodes полезны в IoT и edge‑сценариях, а также когда локальный трафик должен иметь низкий RTT и оставаться локальным, если только не нужно маршрутизировать в супер‑кластер. Семантика очередей NATS соблюдается через leaf‑подключения за счет обслуживания локальных queue‑consumers в первую очередь.

- Клиенты leaf‑nodes аутентифицируются локально (или просто подключаются, если аутентификация не требуется)
- Трафик между leaf‑node и кластером подчиняется ограничениям конфигурации пользователя, используемого для создания leaf‑подключения.
  - Subject, в которые пользователю разрешено публиковать, экспортируются в кластер.
  - Subject, на которые пользователю разрешено подписываться, импортируются в leaf‑node.

В отличие от узлов [cluster](../clustering/) или [gateway](../gateways/), leaf‑nodes не обязаны быть достижимыми сами по себе и могут использоваться для явной настройки любых ациклических топологий графа.

Если leaf‑node подключается к кластеру, рекомендуется настроить его с знанием **всех** _seed‑серверов_ и чтобы **каждый** _seed‑сервер_ принимал подключения leaf‑nodes. Если конфигурация удаленного кластера меняется, протокол обнаружения будет распространять (gossip) peers, способных принимать leaf‑подключения. Leaf‑node может иметь несколько remote‑подключений, каждое — к разному кластеру. Каждый URL в remote должен указывать на один и тот же кластер. Если один узел кластера настроен как leaf‑node, то **все** узлы должны быть так настроены. Аналогично, если один сервер в кластере принимает leaf‑подключения, **все** серверы должны принимать их.

> Leaf Nodes — важный компонент, позволяющий мостить трафик между локальными серверами NATS, которыми вы управляете, и серверами, управляемыми третьей стороной. [NGS от Synadia](https://www.synadia.com/cloud) позволяет аккаунтам использовать leaf‑nodes и получать доступ к глобальной сети, чтобы недорого соединять географически распределенные серверы или небольшие кластеры.

[Опции конфигурации LeafNode](leafnode_conf.md)

## Руководство по конфигурации LeafNode

Основной сервер — это обычный NATS‑сервер. Клиенты основного кластера используют токен‑аутентификацию, но может использоваться любой вид аутентификации. Сервер принимает leaf‑подключения на порту 7422 (порт по умолчанию):

```
leafnodes {
    port: 7422
}
accounts: {
    app: { 
        users: [
            {user: appuser, password: s3cr3t},
            {user: leafuser, password: s3cr3t}
           ]
    }  
}
```

Запустите сервер:

```bash
nats-server -c /tmp/server.conf
```

Фрагмент вывода

```text
...
[5774] 2019/12/09 11:11:23.064276 [INF] Listening for leafnode connections on 0.0.0.0:7422
...
```

Создаем ответчик на сервере, который будет слушать запросы на `q` и отвечать `42`:

```bash
nats reply -s nats://appuser:s3cr3t@localhost q 42
```

Leaf‑node позволяет локальным клиентам подключаться через порт 4111 и не требует аутентификации. Конфигурация задает, где находится удаленный кластер и как к нему подключаться (в этом случае — простой токен):

```
listen: "127.0.0.1:4111"
leafnodes {
    remotes = [
        {
          url: "nats://leafuser:s3cr3t@localhost"
        },
    ]
}
```

В случае, когда удаленное leaf‑подключение идет по `tls`:

```
listen: "127.0.0.1:4111"
leafnodes {
    remotes = [
        {
          url: "tls://leafuser:s3cr3t@localhost"
        },
    ]
}
```

Обратите внимание: конфигурация leaf‑node содержит несколько `remotes`. Поле `url` указывает порт на сервере, где разрешены leaf‑подключения.

Запустите leaf‑node сервер:

```bash
nats-server -c /tmp/leaf.conf
```

Фрагмент вывода

```text
....
[3704] 2019/12/09 09:55:31.548308 [INF] Listening for client connections on 127.0.0.1:4111
...
[3704] 2019/12/09 09:55:31.549404 [INF] Connected leafnode to "localhost"
```

Подключите клиента к leaf‑серверу и сделайте запрос `q`:

```bash
nats req -s nats://127.0.0.1:4111 q ""
```

```text
Published [q] : ''
Received  [_INBOX.Ua82OJamRdWof5FBoiKaRm.gZhJP6RU] : '42'
```

## Пример Leaf Node с использованием удаленного глобального сервиса

В этом примере мы подключаем leaf‑node к [NGS](https://www.synadia.com/cloud) от Synadia. Leaf‑nodes поддерживаются на бесплатных аккаунтах разработчика и платных аккаунтах. Чтобы использовать NGS, убедитесь, что вы зарегистрировались и у вас есть аккаунт, загруженный в локальную систему. Если аккаунта нет, это займет менее 30 секунд, чтобы завести бесплатный и продолжить!

Инструмент `nsc` может работать с множеством аккаунтов и операторов, поэтому важно убедиться, что вы работаете с правильным оператором и аккаунтом. Аккаунт можно задать через `nsc`, как показано ниже. В примере используется аккаунт `DELETE_ME`, зарегистрированный в NGS как бесплатный.

```bash
❯ nsc env -a DELETE_ME
❯ nsc describe account
+--------------------------------------------------------------------------------------+
|                                   Account Details                                    |
+---------------------------+----------------------------------------------------------+
| Name                      | DELETE_ME                                                |
| Account ID                | ABF3NX7FJLDCUO5QXBH56PV6EU4PR5HFCUJBXAG57AKSDUBTGORDFOLI |
| Issuer ID                 | ODSKBNDIT3LTZWFSRAWOBXSBZ7VZCDQVU6TBJX3TQGYXUWRU46ANJJS4 |
| Issued                    | 2023-03-02 18:18:42 UTC                                  |
| Expires                   |                                                          |
+---------------------------+----------------------------------------------------------+
| Max Connections           | 10                                                       |
| Max Leaf Node Connections | Not Allowed                                              |
| Max Data                  | 1.0 GB (1000000000 bytes)                                |
| Max Exports               | 2                                                        |
| Max Imports               | 7                                                        |
| Max Msg Payload           | 1.0 kB (1000 bytes)                                      |
| Max Subscriptions         | 10                                                       |
| Exports Allows Wildcards  | True                                                     |
| Disallow Bearer Token     | False                                                    |
| Response Permissions      | Not Set                                                  |
+---------------------------+----------------------------------------------------------+
| Jetstream                 | Disabled                                                 |
+---------------------------+----------------------------------------------------------+
| Exports                   | None                                                     |
+---------------------------+----------------------------------------------------------+
```

Инструмент `nsc` знает об аккаунте, поэтому продолжим и создадим пользователя для примера.

```bash
nsc add user leaftestuser
```

```text
[ OK ] generated and stored user key "UB5QBEU4LU7OR26JEYSG27HH265QVUFGXYVBRD7SVKQJMEFSZTGFU62F"
[ OK ] generated user creds file "~/.nkeys/creds/synadia/leaftest/leaftestuser.creds"
[ OK ] added user "leaftestuser" to account "leaftest"
```

Сконфигурируем leaf‑подключение, как делали ранее:

```
leafnodes {
    remotes = [
        {
          url: "tls://connect.ngs.global"
          credentials: "/Users/alberto/.nkeys/creds/synadia/leaftest/leaftestuser.creds"
        },
    ]
}
```

Порт по умолчанию для leaf‑nodes — 7422, поэтому его указывать не нужно.

Запустим leaf‑сервер:

```bash
nats-server -c /tmp/ngs_leaf.conf
```

```text
...
[4985] 2023/03/03 10:55:51.577569 [INF] Listening for client connections on 0.0.0.0:4222
...
[4985] 2023/03/03 10:55:51.918781 [INF] Connected leafnode to "connect.ngs.global"
```

Снова подключим ответчик, но на этот раз к NGS Synadia. NSC подключается, указывая файл учетных данных:

```bash
nsc reply q 42
```

И теперь отправим запрос с локального хоста:

```bash
nats-req q ""
```

```text
Published [q] : ''
Received  [_INBOX.hgG0zVcVcyr4G5KBwOuyJw.uUYkEyKr] : '42'
```

## Авторизация Leaf

В некоторых случаях вы можете захотеть ограничить, какие сообщения можно экспортировать из leaf‑node или импортировать через leaf‑подключение. Можно задать ограничения, ограничив то, на какие subject может публиковать и на какие подписываться клиент leaf‑подключения. См. [NATS Authorization](../securing_nats/authorization.md) как это сделать.

## TLS‑first Handshake

_Начиная с NATS v2.10.0_

Leaf‑подключения следуют модели, где при создании TCP‑соединения сервер немедленно отправляет [INFO‑сообщение протокола](../../../reference/nats-protocol/nats-protocol/README.md#info) в открытом виде. Это INFO‑сообщение содержит метаданные, включая требование защищенного соединения.

Некоторые среды предпочитают, чтобы сервер, настроенный принимать TLS‑подключения для leaf‑nodes, не отправлял никакой трафик в открытом виде. Ранее это можно было обойти, используя websocket‑подключение. Однако если websocket не желателен, принимающий и удаленный серверы можно [настроить](./leafnode_conf.md#tls-block) так, чтобы выполнять TLS‑рукопожатие до отправки INFO‑сообщения протокола.

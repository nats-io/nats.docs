# Супер‑кластер с Gateways

## Gateways

Gateways позволяют соединять один или несколько кластеров в полносвязную сеть; они позволяют формировать супер‑кластеры из меньших кластеров. Протоколы Cluster и Gateway слушают разные порты. Кластеризация используется для соседних серверов; gateways — для объединения кластеров.

Конфигурация gateway похожа на кластеризацию:

* у gateways есть выделенный порт, на котором они принимают gateway‑запросы
* gateways распространяют (gossip) gateway‑узлы и удаленные обнаруженные gateways

В отличие от кластеров, gateways:

* имеют имена, определяющие кластер, в котором они находятся
* не образуют полносвязную сеть между gateway‑узлами, но образуют полносвязную сеть между кластерами
* связаны однонаправленными соединениями
* не распространяют информацию о gateway‑узлах клиентам

Gateways нужны, чтобы:

* уменьшить количество соединений между серверами
* оптимизировать распространение графа интересов

Если gateways используются в кластере, **все** серверы этого кластера должны иметь gateway‑конфигурацию с **одинаковым именем**.  
Кроме того, каждый gateway‑узел должен иметь возможность **подключиться к любому** другому gateway‑узлу и наоборот. Все остальное считается неверной конфигурацией.

## Gateway‑соединения

`nats-server` в роли gateway задает порт, на котором будет принимать gateway‑подключения. Если конфигурация указывает другие _внешние_ `gateways`, gateway создаст по одному исходящему gateway‑соединению для каждого gateway в конфигурации. Также он будет распространять (gossip) другие gateways, которые он знает или обнаружил. Чем меньше _внешних_ `gateways`, тем меньше конфигурации. Но способность обнаруживать больше gateways и gateway‑узлов зависит от того, что эти серверы работают. Это похоже на _seed server_ в кластере. Рекомендуется перечислить все _seed‑серверы_ кластера в разделе `gateways`.

Если локальный кластер имеет три gateway‑узла, это означает три исходящих подключения из локального кластера к каждому внешнему gateway‑кластеру.

![Gateway Connections](../../../.gitbook/assets/simple.svg)

> В примере выше кластер _A_ настроил gateway‑соединения к _B_ (сплошные линии). _B_ обнаружил gateway‑соединения к _A_ (пунктирные линии). Обратите внимание: число исходящих соединений всегда соответствует числу gateways с тем же именем.

![Gateway Discovered Gateways](../../../.gitbook/assets/three_gw.svg)

> Во втором примере настроенные соединения показаны сплошными линиями, а обнаруженные — пунктиром. Gateways _A_ и _C_ были обнаружены через gossip; _B_ обнаружил _A_, а _A_ обнаружил _C_.

Ключевой момент в описании выше: каждый узел в кластере делает соединение с одним узлом в каждом удаленном кластере — в отличие от протокола кластеризации, где каждый узел напрямую соединен со всеми другими узлами.

Для тех, кто любит математику: количество кластерных соединений — `N(N-1)/2`, где _N_ — число узлов в кластере. В конфигурациях gateway число исходящих соединений — это сумма `Ni(M-1)`, где Ni — число узлов в gateway _i_, а _M_ — общее число gateways. Входящие соединения — сумма `U-Ni`, где U — сумма всех gateway‑узлов во всех gateways, а N — число узлов в gateway _i_. В результате количества входящих и исходящих соединений совпадают.

Разница в количестве соединений для объединения кластеров через кластеризацию и через gateways становится очевидной очень быстро. Для 3 кластеров по N узлов:

| Узлов в кластере | Полносвязные соединения | Gateway‑соединения |
| ---: | ---: | ---: |
| 1 | 3 | 6 |
| 2 | 15 | 12 |
| 3 | 36 | 18 |
| 4 | 66 | 24 |
| 5 | 105 | 30 |
| 30 | 4005 | 180 |

Раздел cluster для gateways не обязателен — они работают и с одиночным сервером. Тем не менее они становятся полезными, когда участвующие кластеры состоят более чем из одного сервера, и уменьшают число соединений.

## Распространение интересов

Сообщения от клиентов, напрямую подключенных к gateway‑узлу, отправляются по исходящим gateway‑соединениям согласно двум механизмам распространения интереса:

* Режим только интереса (Interest‑only)
* Queue‑подписки

Если локальный интерес позволяет, принимающий gateway‑узел отправляет сообщения напрямую своим подписанным клиентам, а также серверу внутри кластера.

### Режим Interest‑only

Gateway _A_ отправляет сообщения только по тем subject, по которым gateway _B_ явно выразил интерес. Когда подписки на _B_ появляются или исчезают, _B_ обновляет свой интерес к subject у _A_.

### Queue‑подписки

Когда queue‑подписчик создает новую подписку, gateway распространяет интерес к подписке на другие gateways. Интерес распространяется только _один раз_ на _Account_ и subject. Когда последний queue‑подписчик исчезает, интерес к кластеру удаляется.

Queue‑подписки работают в режиме _Interest‑only_ и соблюдают семантику очередей NATS на уровне _Super Cluster_. Для каждой queue‑группы сообщение доставляется только одному queue‑подписчику. Если та же queue‑группа существует в нескольких кластерах, сервер выберет одного участника queue‑группы в своем кластере и отправит в другой кластер только при отсутствии интереса в своем кластере. Иными словами, сервер всегда сначала пытается обслужить локальных queue‑подписчиков и только затем делает failover, если локальный подписчик не найден. Сервер выбирает кластер с наименьшим RTT.

### Конфигурация gateway

Документ [Gateway Configuration](gateway.md) описывает все доступные опции для gateways.

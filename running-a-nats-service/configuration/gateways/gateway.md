# Конфигурация

Блок конфигурации `gateway` похож на блок [`cluster`](../clustering/cluster_config.md):

```
gateway {
    name: "A"
    listen: "localhost:7222"
    authorization {
        user: gwu
        password: gwp
    }

    gateways: [
        {name: "A", url: "nats://gwu:gwp@localhost:7222"},
        {name: "B", url: "nats://gwu:gwp@localhost:7333"},
        {name: "C", url: "nats://gwu:gwp@localhost:7444"},
    ]
}
```

Одно отличие: вместо `routes` указывается `gateways`. Как и ожидается, соединения _self‑gateway_ игнорируются, поэтому можно переиспользовать конфигурации gateway без лишних хлопот.

Запуск сервера:

```shell
nats-server -c A.conf
```

```
[85803] 2019/05/07 10:50:55.902474 [INF] Starting nats-server version 2.0.0
[85803] 2019/05/07 10:50:55.903669 [INF] Gateway name is A
[85803] 2019/05/07 10:50:55.903684 [INF] Listening for gateways connections on localhost:7222
[85803] 2019/05/07 10:50:55.903696 [INF] Address for gateway "A" is localhost:7222
[85803] 2019/05/07 10:50:55.903909 [INF] Listening for client connections on 0.0.0.0:4222
[85803] 2019/05/07 10:50:55.903914 [INF] Server id is NBHUDBF3TVJSWCDPG2HSKI4I2SBSPDTNYEXEMOFAZUZYXVA2IYRUGPZU
[85803] 2019/05/07 10:50:55.903917 [INF] Server is ready
[85803] 2019/05/07 10:50:56.830669 [INF] 127.0.0.1:50892 - gid:2 - Processing inbound gateway connection
[85803] 2019/05/07 10:50:56.830673 [INF] 127.0.0.1:50891 - gid:1 - Processing inbound gateway connection
[85803] 2019/05/07 10:50:56.831079 [INF] 127.0.0.1:50892 - gid:2 - Inbound gateway connection from "C" (NBHWDFO3KHANNI6UCEUL27VNWL7NWD2MC4BI4L2C7VVLFBSMZ3CRD7HE) registered
[85803] 2019/05/07 10:50:56.831211 [INF] 127.0.0.1:50891 - gid:1 - Inbound gateway connection from "B" (ND2UJB3GFUHXOQ2UUMZQGOCL4QVR2LRJODPZH7MIPGLWCQRARJBU27C3) registered
[85803] 2019/05/07 10:50:56.906103 [INF] Connecting to explicit gateway "B" (localhost:7333) at 127.0.0.1:7333
[85803] 2019/05/07 10:50:56.906104 [INF] Connecting to explicit gateway "C" (localhost:7444) at 127.0.0.1:7444
[85803] 2019/05/07 10:50:56.906404 [INF] 127.0.0.1:7333 - gid:3 - Creating outbound gateway connection to "B"
[85803] 2019/05/07 10:50:56.906444 [INF] 127.0.0.1:7444 - gid:4 - Creating outbound gateway connection to "C"
[85803] 2019/05/07 10:50:56.906647 [INF] 127.0.0.1:7444 - gid:4 - Outbound gateway connection to "C" (NBHWDFO3KHANNI6UCEUL27VNWL7NWD2MC4BI4L2C7VVLFBSMZ3CRD7HE) registered
[85803] 2019/05/07 10:50:56.906772 [INF] 127.0.0.1:7333 - gid:3 - Outbound gateway connection to "B" (ND2UJB3GFUHXOQ2UUMZQGOCL4QVR2LRJODPZH7MIPGLWCQRARJBU27C3) registered
```

Когда все gateways подняты, эти «кластеры из одного» будут передавать сообщения как ожидается:

```shell
nats sub -s localhost:4333 ">"
```

В другой сессии...

```shell
nats pub -s localhost:4444 foo bar
```

Подписчик должен вывести:

```
[#1] Received on [foo] : 'bar'
```

## Блок конфигурации `Gateway`

| Свойство                 | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Версия |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------|
| `name`                   | Имя кластера. Все gateways, принадлежащие одному кластеру, должны указывать одинаковое имя.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |         |
| `reject_unknown_cluster` | Если `true`, gateway будет отклонять соединения от кластеров, которые не настроены в `gateways`. Делает это, проверяя, что имя кластера, переданное входящим соединением, существует как именованный gateway. Это фактически отключает gossip новых кластеров. Это не ограничивает сконфигурированный gateway (и, следовательно, кластер) в динамическом росте.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |         |
| `gateways`               | Список [записей](gateway.md#gateway-entry) gateway — см. ниже.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |         |
| `host`                   | Интерфейс, на котором gateway будет слушать входящие gateway‑соединения.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |         |
| `port`                   | Порт, на котором gateway будет слушать входящие gateway‑соединения.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |         |
| `listen`                 | Объединяет `host` и `port` как `<host>:<port>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |         |
| `tls`                    | Карта конфигурации [`tls`](../securing_nats/tls.md) для защиты gateway‑соединений. `verify` всегда включен. Если в [`gateway`](gateway.md#gateway-entry) не указано иное, `cert_file` будет сертификатом клиента по умолчанию. См. [подводные камни сертификатов](../securing_nats/tls.md).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |         |
| `advertise`              | Hostport `<host>:<port>`, который будет объявлен другим участникам gateway как способ связаться с этим сервером. Полезно в конфигурациях с NAT или в облаке при экспонировании через Network Load Balancer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |         |
| `connect_retries`        | После какого количества неудачных попыток подключения прекратить попытки к обнаруженному gateway. По умолчанию `0` — не повторять. При включении попытки делаются раз в секунду. Не применяется к явно сконфигурированным gateways.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |         |
| `connect_backoff`        | Включить экспоненциальную задержку при попытках переподключения. Если `true`, будет использован экспоненциальный backoff от 1 до 30 секунд.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 2.12.0  |
| `authorization`          | Карта [авторизации](../securing_nats/auth_intro/#authorization-map) для gateways. Когда используется один `username`/`password`, это определяет механизм аутентификации, который ожидает этот сервер, и как этот сервер будет аутентифицироваться при установке соединения с _обнаруженным_ gateway. Это не используется для gateways, явно перечисленных в [`gateways`](gateway.md#gateway-entry), поэтому такие учетные данные должны быть частью URL. При этом режиме аутентификации либо используйте одинаковые учетные данные во всей системе, либо перечисляйте каждый gateway явно на каждом сервере. Если карта `tls` задает `verify_and_map`, указывайте только ожидаемый `username`. Здесь можно использовать разные сертификаты, но они должны сопоставляться с одним и тем же `username`. Карта авторизации также допускает `timeout`, он учитывается, но конфигурации `users` и `token` не поддерживаются и приведут к тому, что сервер не запустится. Блок `permissions` игнорируется. |         |

### Запись `Gateway`

Блок конфигурации `gateways` — это список записей gateway со следующими свойствами:

| Свойство | Описание                                                                                                                                                                                                                                                                                                                                                   |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `name`   | Имя gateway.                                                                                                                                                                                                                                                                                                                                                 |
| `url`    | Hostport `<host>:<port>`, описывающий, где доступен удаленный gateway. Если возвращается несколько IP, один выбирается случайно.                                                                                                                                                                                                                          |
| `urls`   | Список строк `url`.                                                                                                                                                                                                                                                                                                                                      |
| `tls`    | Карта конфигурации [`tls`](../securing_nats/tls.md) для создания защищенного gateway‑соединения. Если верхнеуровневый блок `gateway{}` `tls` содержит сертификаты и для клиента, и для сервера, то этот блок можно опустить, и сервер использует сертификаты из `gateway{tls{}}`. См. дополнительные рекомендации ниже в разделе TLS Entry. |

Используя `urls` и массив, вы можете указать список endpoint’ов, которые являются частью кластера, как показано ниже. Сервер NATS выберет один из этих адресов случайно и установит только одно исходящее gateway‑соединение к одному из участников другого кластера:

```
gateway {
    name: "DC-A"
    listen: "localhost:7222"

    gateways: [
        {name: "DC-A", urls: ["nats://localhost:7222", "nats://localhost:7223", "nats://localhost:7224"]},
        {name: "DC-B", urls: ["nats://localhost:7332", "nats://localhost:7333", "nats://localhost:7334"]},
        {name: "DC-C", urls: ["nats://localhost:7442", "nats://localhost:7333", "nats://localhost:7335"]}
    ]
}
```

### TLS Entry

В дополнение к обычным рекомендациям по TLS, учитывайте, что ключи и сертификаты TLS для нескольких кластеров или серверов в разных локациях редко ротируются одновременно, а центры сертификации могут переходить между разными промежуточными сертификатами.

Если вы используете bundle сертификата, выданный вместе с сертификатом, то CA в этом bundle обычно подходит только для этого сертификата. Использовать _только_ этот CA для аутентификации gateway — плохая идея. Нужно предусмотреть ротацию между центрами сертификации, даже если это несколько CA одной организации, и использовать отдельный bundle сертификатов для _проверки_ peers. Так, когда DC‑B ротируется раньше DC‑A, он не будет отрезан от супер‑кластера.

### Gateway за балансировщиком нагрузки

При работе в приватной сети (например, VPC в облаке) вы, скорее всего, захотите настроить Load Balancer для экспонирования порта gateway. В этом случае важно установить значение `advertise` на каждом сервере NATS в hostname и порт Load Balancer, которые их обслуживают. Иначе они будут объявлять свой собственный приватный IP и порт, что может приводить к сбоям и простоям при необходимости переподключения.

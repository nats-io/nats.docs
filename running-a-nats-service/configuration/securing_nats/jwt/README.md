# Децентрализованная JWT‑аутентификация/авторизация

В других механизмах аутентификации конфигурация идентификации пользователя и [Account](../accounts.md) находится в конфигурационном файле сервера. JWT‑аутентификация использует [JSON Web Tokens (JWT)](https://jwt.io/) для описания поддерживаемых сущностей. Когда клиент подключается, серверы проверяют подлинность запроса с помощью [NKeys](../auth_intro/nkey_auth.md), загружают информацию об аккаунте и валидируют цепочку доверия. Пользователи напрямую сервером не отслеживаются, а проверяются как принадлежащие [Account](../accounts.md). Это позволяет управлять пользователями без необходимости обновлять конфигурации сервера.

По сути, JWT улучшает accounts и предоставляет **распределенную парадигму конфигурации**. Раньше каждый пользователь (или клиент) должен был быть заранее известен и авторизован в конфигурации сервера, требуя от администратора модификации и обновления конфигов. Эти задачи исчезают. Создание пользователей может выполняться даже другими сущностями.

> Примечание: эта схема улучшает [accounts](../accounts.md). Функции вроде [изоляции](../accounts.md) или определения [exports/imports](../accounts.md#exporting-and-importing) между аккаунтами сохраняются! Она переносит конфигурацию аккаунтов, exports/imports или пользователей и их прав с сервера в несколько доверенных [JSON Web Token (JWT)](https://jwt.io/), управляемых отдельно, тем самым убирая необходимость конфигурировать эти сущности на каждом сервере. Также добавляет возможности вроде истечения и отзыва для децентрализованного управления аккаунтами.

## JSON Web Tokens

[JSON Web Tokens (JWT)](https://jwt.io/) — открытый отраслевой стандарт [RFC7519](https://tools.ietf.org/html/rfc7519) для безопасного представления claims между двумя сторонами.

Claims — это способ утверждать информацию о _subject_. В этом контексте _subject_ — описываемая сущность (не messaging subject). Стандартные JWT‑claims обычно подписываются и проверяются цифровой подписью.

NATS дополнительно ограничивает JWT, требуя, чтобы JWT были:

* Всегда цифрово подписаны и только с использованием [Ed25519](https://ed25519.cr.yp.to/).
* NATS использует соглашение, что все поля _Issuer_ и _Subject_ в JWT‑claim должны быть публичным [NKEY](../auth_intro/nkey_auth.md).
* _Issuer_ и _Subject_ должны соответствовать конкретным ролям в [NKeys](https://github.com/nats-io/nkeys).

<a id="nkey-roles"></a>
### Роли NKey

Роли [NKeys](../auth_intro/nkey_auth.md):

* Operators
* Accounts
* Users

Роли иерархичны и формируют цепочку доверия. Операторы выпускают аккаунты, которые, в свою очередь, выпускают пользователей. Серверы доверяют конкретным операторам. Если аккаунт выпущен доверенным оператором, пользователи аккаунта доверены.

## Процесс аутентификации

Когда _User_ подключается к серверу, он предоставляет JWT, выпущенный его _Account_. Пользователь доказывает свою личность, подписывая криптографический challenge сервера своим приватным ключом. Проверка подписи подтверждает, что подпись принадлежит публичному ключу пользователя. Далее сервер извлекает соответствующий JWT аккаунта, который выпустил пользователя. Он проверяет, что issuer пользователя соответствует ссылочному аккаунту. Наконец, сервер проверяет, что доверенный _Operator_ — тот, на которого настроен сервер — выпустил _Account_, завершая проверку цепочки доверия.

## Процесс авторизации

С точки зрения авторизации аккаунт предоставляет информацию о messaging subject, импортируемых из других аккаунтов (включая связанные правила), а также о subject, экспортируемых в другие аккаунты. Аккаунты также могут иметь лимиты, например максимальное число соединений. JWT пользователя может выражать ограничения на subject, на которые он может публиковать или подписываться.

Когда новый пользователь добавляется в аккаунт, конфигурацию аккаунта менять не нужно, так как у каждого пользователя может и должен быть свой JWT, который проверяется простым разрешением его родительского аккаунта.

## JWT и приватность

Важно помнить, что хотя в других системах JWT используются как сессии или доказательство аутентификации, JWT в NATS используются только как конфигурация, описывающая:

* публичный ID сущности
* публичный ID сущности, которая ее выпустила
* возможности сущности

Аутентификация — это криптографический процесс на публичных ключах: клиент подписывает nonce, доказывая личность, а цепочка доверия и конфигурация обеспечивают авторизацию.

Сервер никогда не видит приватные ключи, но может проверить, что подписант или эмитент действительно соответствует указанному или известному публичному ключу.

Наконец, все JWT NATS (Operators, Accounts, Users и другие) должны быть подписаны алгоритмом [Ed25519](https://ed25519.cr.yp.to/). Если это не так, система их отклонит.

## Децентрализованная аутентификация и авторизация — конфигурация и nsc

Чтобы включить безопасность operator JWT, на nats-server нужно настроить минимум. После первоначальной настройки сервера аутентификация и авторизация обычно выполняются с помощью административного инструмента `nsc` локально и синхронизации с account resolvers, встроенными в nats-server.

Конфигурация разбита на отдельные шаги. В зависимости от потребностей организации их выполняют одни и те же или разные сущности.

На практике JWT‑конфигурация выполняется с помощью инструмента [`nsc`](../../../../using-nats/nats-tools/nsc/README.md). Он может выпускать [NKeys](../auth_intro/nkey_auth.md) и соответствующие JWT для всех [ролей nkey](#nkey-roles): Operator/Account/User ([пример использования](../../../../using-nats/nats-tools/nsc/basics.md#creating-an-operator-account-and-user)). Несмотря на то, что создание Account и User не происходит в конфигурации сервера, эта модель — централизованная настройка аутентификации и авторизации.

При наличии институционального доверия также возможно использовать nsc для импорта публичных [NKeys](../auth_intro/nkey_auth.md) аккаунта или пользователя и выпуска соответствующих JWT. Таким образом оператор может выпускать JWT аккаунтов, а отдельная сущность — JWT пользователей своего аккаунта. Ни одна из сторон не обязана знать приватный Nkey другой. Это позволяет настраивать пользователей не на серверах и даже разными организациями. Например, администраторы установки NATS управляют операторами и выдают JWT аккаунтов отдельным прод/дев командам, которые управляют своими пользователями. Это полностью децентрализованная настройка авторизации!

Когда Operator JWT на месте, сервер нужно настроить, чтобы ему доверять, указав `operator`. Кроме того, серверу нужен способ получать JWT аккаунтов. Это делается либо по умолчанию через resolver, указанный в operator JWT, либо вручную через [resolver](resolver.md). В зависимости от конфигурации может понадобиться [account server](../../../../using-nats/nats-tools/nsc/basics.md#account-server-configuration).

> Можно [смешивать](jwt_nkey_auth.md) JWT‑ и [NKEY](../auth_intro/nkey_auth.md)/[Account](../accounts.md)‑основанную аутентификацию/авторизацию.

# Управление JWT‑аутентификацией

Больше информации — в [глубоком руководстве](../../../../running-a-nats-service/nats_admin/jwt.md).

# Особенности среды

## Сеть

### Балансировщики нагрузки
Развернуть балансировщик между клиентскими приложениями и серверами кластера (или даже между серверами в кластере или между кластерами в супер‑кластере) можно, но в этом нет необходимости: NATS уже имеет собственные механизмы балансировки подключений между seed‑узлами в URL подключения (включая рандомизацию DNS A‑записей клиентами) и автоматического восстановления разорванных соединений.
Если у вас кластер из 3 seed‑узлов, вы часто получите более высокую сетевую пропускную способность, чем при прохождении через балансировщик (балансировщики облачных провайдеров могут быть заметно недомощными, не говоря уже о том, что они обычно тарифицируются по объему трафика).
Наконец, если вы хотите использовать TLS для аутентификации, не стоит завершать TLS на балансировщике.

{% hint style="warning" %}
Если вы решили использовать балансировщики с NATS, нужно понимать поведение клиентских и кластерных соединений и авто‑обнаружения.  

Клиентские соединения и маршруты постоянны. Поэтому балансировщик не будет распределять сообщения от одного клиентского соединения между серверами, или, что хуже (что часто случается при автоконфигурации), вы можете получить избыточные, но несвязанные (не кластеризованные) серверы, к которым клиенты будут подключаться случайным образом. [Advertising нужно отключить](configuration/clustering/cluster_config.md) или настроить так, чтобы он указывал на адрес балансировщика через опцию [`advertise` в конфигурации сервера](configuration/clustering/cluster_config.md). 

Балансировщики также могут вызывать проблемы из‑за неверной настройки idle‑детекции, проблем протокола из‑за инспекции пакетов и проблем с эфемерными портами при высоких масштабах.

Если маршруты или gateway‑подключения проходят через балансировщики, у вас вполне могут возникнуть описанные выше проблемы, что может приводить к периодам потери кворума JetStream и создавать избыточную нагрузку на ресинхронизацию и протокольный трафик.
{% endhint %}

Есть и здравые сценарии использования балансировщиков для клиентских подключений.
Если балансируемые серверы NATS настроены как кластеры (или супер‑кластеры) и обеспечивают прозрачную маршрутизацию сообщений, балансировщик может упростить клиентскую конфигурацию, предоставив одну точку входа, или автоматически подключать к географически ближайшему узлу кластера.


## Виртуализация, контейнеризация

NATS «cloud native» и предполагается к разворачиванию в виртуальных средах и/или контейнерах.

Однако, если ваша цель — максимальная производительность, которую может дать NATS, стоит помнить несколько вещей.

Думайте о серверах Core NATS как о программном эквиваленте сетевых коммутаторов. Включите JetStream — и они также становятся новым типом БД‑сервера.

Что нужно помнить при выборе типов инстансов и вариантов хранения для хостов NATS‑серверов в публичных облаках: *вы получаете то, за что платите*.

Например, не оптимизированные для сети инстансы могут дать вам 10 Гбит/с, но только на некоторый период (например, 30 минут), после чего доступная полоса может значительно упасть (например, до 5 Гбит/с) на еще один период. Поэтому, если вам всегда нужна заявленная пропускная способность, выбирайте инстансы, оптимизированные под сеть.

То же самое с вариантами хранения: локальные SSD дают лучшую латентность, а сетевое блочное хранилище (например, Amazon EBS) — наибольшую общую пропускную способность. При использовании EBS опять же действует правило «получаете то, за что платите»: хранилище общего назначения может давать определенное число IOPS, но поддерживать его можно лишь ограниченное время, после чего показатель может резко упасть. Поэтому выбирайте IO‑оптимизированные типы хранения, если хотите постоянно удерживать одно и то же максимальное число IOPS (например, [AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-volume-types.html)).

### Лимиты ресурсов

Будьте осторожны при установке лимитов ресурсов для контейнеров nats-server. Процессы nats-server используют ресурсы пропорционально нагрузке от всех клиентских приложений. Если использование NATS (и JetStream) высокое или всплескообразное (nats-server очень быстрый и может обрабатывать резкие пики трафика), то нужно соответствующе выставить лимиты ресурсов контейнера, иначе система оркестрации контейнеров завершит контейнер сервера. nats-server автоматически определяет количество доступных ядер, но он будет пытаться использовать всю память хоста, а не лимит ресурсов контейнера, если не задан GOMEMLIMIT. GOMEMLIMIT доступен в официальных Helm‑чартах NATS.

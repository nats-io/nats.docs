# Установка сервера NATS

Философия NATS — простота. Установка сводится к распаковке zip‑файла и копированию бинарника в подходящий каталог; также можно использовать любимый менеджер пакетов. Ниже приведены разные способы установить или запустить NATS:

* [Командная строка](installation.md#getting-the-binary-from-the-command-line)
* [Docker](installation.md#installing-via-docker)
* [Kubernetes](nats-on-kubernetes/nats-kubernetes.md)
* [Менеджер пакетов](installation.md#installing-via-a-package-manager)
* [Release‑архив](installation.md#downloading-a-release-build)
* [Сборка для разработки](installation.md#installing-from-the-source)

См. также [установку клиента NATS](clients.md#installing-the-nats-cli-tool)

## Поддерживаемые ОС и архитектуры

Таблица ниже показывает текущие поддерживаемые комбинации ОС и архитектур для сборок сервера NATS.

| Операционная система | Архитектуры                                  | Статус       |
| -------------------- | -------------------------------------------- | ------------ |
| Darwin (macOS)       | amd64, arm64                                 | Stable       |
| Linux                | amd64, 386, arm6, arm7, arm64, mips64le, s390x | Stable       |
| Windows              | amd64, 386, arm6, arm7, arm64                | Stable       |
| FreeBSD              | amd64                                        | Stable       |
| NetBSD               | -                                            | Experimental |
| IBM z/OS             | -                                            | Experimental |

_Примечание: не все методы установки ниже имеют дистрибутивы для всех комбинаций ОС и архитектуры._

## Требования к железу

Сервер NATS сам по себе имеет минимальные требования и подходит для небольших edge‑устройств, но при наличии ресурсов может ими эффективно воспользоваться.

CPU стоит учитывать при приеме TLS‑соединений. После сетевого разделения каждый отключенный клиент будет одновременно пытаться подключиться к серверу NATS в кластере, поэтому CPU на этих серверах кратковременно «взлетит». При большом числе клиентов это можно смягчить настройками jitter при переподключении, уменьшить ошибки можно более длинными TLS‑таймаутами и масштабированием кластера.

Мы настоятельно рекомендуем протестировать, хватит ли для вашей нагрузки небольших и более дешевых машин — часто их достаточно. Мы предлагаем начать с этого и корректировать ресурсы после нагрузочного тестирования, специфичного для вашей среды. При выборе типов инстансов у облачных провайдеров убедитесь, что у узла достаточно производительная сетевая карта (NIC) для нужной пропускной способности.

Для сценариев с высокой пропускной способностью именно NIC или доступная полоса часто становятся узким местом, поэтому проверьте, что железо или тип инстанса облака удовлетворяет вашим требованиям.

### Core NATS

Таблицы ниже показывают **минимальное количество ядер и памяти** для стабильной работы кластера при разных комбинациях издателей, подписчиков и скоростей сообщений.  
Под стабильностью понимается отсутствие деградации и нехватки памяти.  
Тесты проводились в контейнерах с `GOMEMLIMIT`, установленным на 90% выделенной памяти, с CPU и SSD уровня 2021 года для хранения JetStream.  
Обратите внимание, что это **минимальные конфигурации**, а в продакшн‑среде могут потребоваться дополнительные ресурсы.

| Размер кластера | Ядра CPU | Память | Подписчики | Издатели | Скорость публикации msg/s | Общая скорость msg/s |
| -------------: | -------: | -----: | ----------: | -------: | ------------------------: | -------------------: |
|            1   |       1  | 32 MiB |           1 |     100  |                      1000 |              100,000 |
|            1   |       1  | 64 MiB |           1 |    1000  |                       100 |              100,000 |
|            3   |       1  | 32 MiB |           1 |    1000  |                       100 |              100,000 |
|            3   |       1  | 64 MiB |           1 |    1000  |                       100 |              100,000 |

### С JetStream

Эта таблица следует той же логике: опубликованные сообщения принимает поток с файловым хранением. Для кластера из трех узлов поток использует три реплики. Подписчики полагаются на pull consumer для выборки сообщений.

| Размер кластера | Ядра CPU | Память | Подписчики | Издатели | Скорость публикации msg/s | Общая скорость msg/s |
| -------------: | -------: | -----: | ----------: | -------: | ------------------------: | -------------------: |
|            1   |       1  |  32 MiB |           1 |      10 |                       100 |                 1,000 |
|            1   |       1  |  32 MiB |           1 |     100 |                        10 |                 1,000 |
|            1   |       1  |  64 MiB |           1 |     100 |                       100 |                10,000 |
|            1   |       1  |  64 MiB |           1 |    1000 |                        10 |                10,000 |
|            3   |       1  |  32 MiB |           1 |     100 |                        10 |                 1,000 |
|            3   |       1  |  64 MiB |           1 |     100 |                       100 |                10,000 |
|            3   |       1  |  64 MiB |           1 |    1000 |                        10 |                10,000 |
|            3   |       1  | 256 MiB |           1 |    1000 |                       100 |               100,000 |

Для **продакшн‑развертывания** JetStream мы рекомендуем начинать как минимум с **4 ядер CPU и 8 ГиБ памяти**, чтобы снизить риск проблем, связанных с ресурсами.

Рекомендации по настройке лимитов в Kubernetes см.: https://github.com/nats-io/k8s/tree/main/helm/charts/nats#nats-container-resources

## Получение бинарника из командной строки

Самый простой способ получить бинарник `nats-server` для вашей машины — использовать следующую команду оболочки.

Например, чтобы получить бинарник версии 2.11.6:

```shell
curl -fsSL https://binaries.nats.dev/nats-io/nats-server/v2@v2.11.6 | sh
```

Чтобы получить последнюю релизную версию, используйте `@latest`. Также можно указать `@main`, чтобы получить latest из main, либо использовать тег, конкретную ветку или хэш коммита после `@`.

## Установка через Docker

С Docker вы можете легко установить сервер, не разбрасывая бинарники и другие артефакты по системе. Единственное требование — [установить docker](https://docs.docker.com/install).

```shell
docker pull nats:latest
```

Чтобы запустить NATS в Docker:

```shell
docker run -p 4222:4222 -ti nats:latest
```

```
[1] 2019/05/24 15:42:58.228063 [INF] Starting nats-server version #.#.#
[1] 2019/05/24 15:42:58.228115 [INF] Git commit [#######]
[1] 2019/05/24 15:42:58.228201 [INF] Starting http monitor on 0.0.0.0:8222
[1] 2019/05/24 15:42:58.228740 [INF] Listening for client connections on 0.0.0.0:4222
[1] 2019/05/24 15:42:58.228765 [INF] Server is ready
```

Подробнее о [NATS в контейнерах](running/nats_docker/).

## Установка через менеджер пакетов

На Windows, используя [scoop.sh](https://scoop.sh):

```shell
scoop install main/nats-server
```

На Mac OS:

```shell
brew install nats-server
```

Arch Linux:

Для пользователей Arch есть [AUR‑пакет](https://aur.archlinux.org/packages/nats-server), который можно установить так:

```shell
yay -S nats-server
```

Чтобы проверить установку (при условии, что исполняемый файл доступен вашей оболочке):

Ввод `nats-server` должен вывести что‑то вроде

```
[41634] 2019/05/13 09:42:11.745919 [INF] Starting nats-server version 2.*.*
[41634] 2019/05/13 09:42:11.746240 [INF] Listening for client connections on 0.0.0.0:4222
...
[41634] 2019/05/13 09:42:11.746249 [INF] Server id is NBNYNR4ZNTH4N2UQKSAAKBAFLDV3PZO4OUYONSUIQASTQT7BT4ZF6WX7
[41634] 2019/05/13 09:42:11.746252 [INF] Server is ready
```


## Загрузка релизной сборки

Последний релиз nats-server можно найти на [странице релизов nats-io/nats-server на GitHub](https://github.com/nats-io/nats-server/releases/).

На странице релизов скопируйте ссылку на архив релиза нужной вам платформы и скачайте с помощью `curl -L`.

Например, для версии сервера X.Y.Z и Linux AMD64:

```shell
curl -L https://github.com/nats-io/nats-server/releases/download/vX.Y.Z/nats-server-vX.Y.Z-linux-amd64.tar.gz -o nats-server.tar.gz
```

```shell
tar -xvzf nats-server.tar.gz
```

```shell
Archive:  nats-server.zip
   creating: nats-server-vX.Y.Z-linux-amd64/
...
```

И наконец:

```shell
sudo cp nats-server-vX.Y.Z-linux-amd64/nats-server /usr/bin
```

## Установка из исходников

Если у вас установлен [Go](https://go.dev/doc/install), установить бинарник просто:

```shell
go install github.com/nats-io/nats-server/v2@main
```

Этот механизм устанавливает сборку ветки [main](https://github.com/nats-io/nats-server), которая почти наверняка не является релизом. Если вы разработчик и хотите поиграть с последними изменениями, это самый простой путь.

Проверить установку (если `$GOPATH/bin` в вашем PATH) можно, набрав `nats-server`, что должно вывести примерно следующее:

```
[2397474] 2023/09/27 10:32:02.709019 [INF] Starting nats-server
[2397474] 2023/09/27 10:32:02.709165 [INF]   Version:  2.11.0-dev
[2397474] 2023/09/27 10:32:02.709182 [INF]   Git:      [not set]
[2397474] 2023/09/27 10:32:02.709185 [INF]   Name:     NDQU7SGA4ECW4PHL4KNBY42AFQEZDAPMMQZVSQDKGTARZI5JHJV6KO2N
[2397474] 2023/09/27 10:32:02.709187 [INF]   ID:       NDQU7SGA4ECW4PHL4KNBY42AFQEZDAPMMQZVSQDKGTARZI5JHJV6KO2N
[2397474] 2023/09/27 10:32:02.709795 [INF] Listening for client connections on 0.0.0.0:4222
[2397474] 2023/09/27 10:32:02.710173 [INF] Server is ready
```

## Сборка из исходников

Мы используем goreleaser для сборки артефактов, публикуемых на [GitHub releases](https://github.com/nats-io/nats-server/releases).  
Наши сборки полностью воспроизводимы, поэтому при установленном Go можно выполнить следующие команды, чтобы собрать из исходников:
```
go install github.com/goreleaser/goreleaser/v2@latest

git clone git@github.com:nats-io/nats-server.git
cd nats-server
git checkout v2.12.0 
[[ `git status --porcelain` ]] && echo "Must have repo in clean state before building"

goreleaser release --skip=announce,publish,validate --clean -f .goreleaser.yml
```
И чтобы проверить SHASUMы относительно релиза:
```
wget https://github.com/nats-io/nats-server/releases/download/v2.12.0/SHA256SUMS
diff --color --minimal --context=0 SHA256SUMS dist/SHA256SUMS
```

# Протокол кластера NATS

## Протокол кластера NATS

Протокол кластеризации NATS описывает сообщения, которыми обмениваются серверы NATS внутри [кластера](../../running-a-nats-service/configuration/clustering/): обмен аккаунтами, подписками, пересылка сообщений и распространение топологии при появлении новых узлов. Это простой текстовый протокол. Серверы взаимодействуют через обычный TCP/IP или TLS-сокет, используя небольшой набор протокольных операций, завершаемых символами новой строки.

Сервер NATS использует [zero allocation byte parser](https://youtu.be/ylRKac5kSOk?t=10m46s), который работает быстро и эффективно.

Протокол кластера очень похож на клиентский протокол NATS. В кластерном контексте полезно мыслить сервер как прокси от имени подключенных клиентов: он подписывается, отписывается, отправляет и получает сообщения.

## Соглашения протокола кластера NATS

**Subject-ы и wildcard-ы**: кластерный протокол использует те же правила и ограничения для subject-ов и wildcard-ов, что и клиентский. Клиенты ограничены одним аккаунтом, а кластерный протокол обслуживает все аккаунты.

**Разделители полей**: поля в протокольных сообщениях NATS разделяются пробелом `' '` или табуляцией `'\t'`. Несколько пробелов подряд считаются одним разделителем.

**Новые строки**: как и другие текстовые протоколы, NATS использует `CR` + `LF` (`\r\n`, `0x0D0A`) для завершения протокольных сообщений. Эта же последовательность используется для отделения payload в сообщении `RMSG`.

## Сообщения протокола кластера NATS

Таблица ниже кратко описывает сообщения кластерного протокола. Как и в клиентском протоколе, имена операций не чувствительны к регистру: `SUB foo 1\r` и `sub foo 1\r` эквивалентны.

Нажмите на имя команды для подробного описания и синтаксиса:

| OP Name                                      | Sent By       | Description                                                                  |
| -------------------------------------------- | ------------- | ---------------------------------------------------------------------------- |
| [`INFO`](nats-server-protocol.md#info)       | All Servers   | Отправляется после начального TCP/IP-подключения и для обновления знаний кластера |
| [`CONNECT`](nats-server-protocol.md#connect) | All Servers   | Отправляется для установления маршрута                                       |
| [`RS+`](nats-server-protocol.md#rs)          | All Servers   | Подписка на subject для заданного аккаунта от имени заинтересованных клиентов |
| [`RS-`](nats-server-protocol.md#rs-1)        | All Servers   | Отписка (или автоотписка) от subject для заданного аккаунта                 |
| [`RMSG`](nats-server-protocol.md#rmsg)       | Origin Server | Доставка сообщения по subject и аккаунту на другой сервер                   |
| [`PING`](nats-server-protocol.md#pingpong)   | All Servers   | PING keep-alive сообщение                                                   |
| [`PONG`](nats-server-protocol.md#pingpong)   | All Servers   | PONG keep-alive ответ                                                       |
| [`-ERR`](nats-server-protocol.md#-err)       | All Servers   | Протокольная ошибка; может привести к разрыву соединения                    |

Ниже разобрано каждое сообщение.

## INFO

### Описание

Сразу после принятия соединения от другого сервера NATS отправляет информацию о себе, конфигурации и требованиях безопасности, необходимых удаленной стороне для успешной аутентификации и обмена сообщениями.

Подключающийся сервер также отправляет `INFO`. Принимающий сервер добавляет поле `ip` с адресом и портом подключившегося сервера и пересылает это `INFO` всем подключенным маршрутам.

Любые серверы, получившие `INFO` с полем `ip`, попытаются подключиться к указанному адресу, если соединение ещё не установлено. Так обеспечивается автообнаружение новых серверов в кластере.

### Синтаксис

`INFO {["option_name":option_value],...}`

Поддерживаемые поля:

* `server_id`: уникальный идентификатор сервера NATS
* `version`: версия сервера NATS
* `go`: версия Go, которой собран сервер
* `host`: host из cluster-настроек
* `port`: порт из cluster-настроек
* `auth_required`: если true, сервер должен аутентифицироваться при подключении
* `tls_required`: если true, требуется TLS-аутентификация
* `max_payload`: максимальный размер payload, принимаемый сервером
* `connect_urls`: список URL серверов, к которым может подключиться клиент
* `ip`: опциональный route-адрес сервера, `nats-route://<hostname>:<port>`

### Пример

Пример строки `INFO` с полем `ip`:

```
INFO {"server_id":"KP19vTlB417XElnv8kKaC5","version":"2.0.0","go":"","host":"localhost","port":5222,"auth_required":false,"tls_required":false,"tls_verify":false,"max_payload":1048576,"ip":"nats-route://127.0.0.1:5222/","connect_urls":["localhost:4222"]}
```

## CONNECT

### Описание

`CONNECT` аналогичен [`INFO`](nats-server-protocol.md#info). После установления TCP/IP-соединения между серверами и получения `INFO` сервер отправляет `CONNECT` с дополнительной информацией о текущем соединении и безопасностью.

### Синтаксис

`CONNECT {["option_name":option_value],...}`

Поддерживаемые поля:

* `tls_required`: требует ли сервер SSL/TLS-соединение
* `auth_token`: токен авторизации
* `user`: имя пользователя соединения (если `auth_required`)
* `pass`: пароль соединения (если `auth_required`)
* `name`: сгенерированное имя сервера
* `lang`: язык реализации сервера (`go`)
* `version`: версия сервера

### Пример

Пример строки `CONNECT`:

`CONNECT {"tls_required":false,"name":"wt0vffeQyoDGMVBC2aKX0b"}\r`

## RS+

### Описание

`RS+` инициирует подписку на subject в указанном аккаунте, опционально с queue group и весом. Для queue-подписок `RS+` используется как при увеличении, так и при уменьшении queue weight, кроме случая, когда вес становится 0.

### Синтаксис

**Подписка**: `RS+ <account> <subject>\r`

**Queue-подписка**: `RS+ <account> <subject> <queue> <weight>\r`

где:

* `account`: аккаунт, связанный с интересом к subject
* `subject`: subject
* `queue`: опциональное имя queue group
* `weight`: опциональный вес queue group, отражающий величину интереса/число подписчиков

## RS-

### Описание

`RS-` отменяет подписку на указанный subject в заданном аккаунте. Сервер отправляет его, когда больше не заинтересован в этом subject.

### Синтаксис

**Подписка**: `RS- <account> <subject>\r`

где:

* `account`: аккаунт, связанный с интересом к subject
* `subject`: subject

## RMSG

### Описание

`RMSG` доставляет сообщение другому серверу.

### Синтаксис

`RMSG <account> <subject> [reply-to] <#bytes>\r\n[payload]\r`

где:

* `account`: аккаунт, связанный с интересом к subject
* `subject`: имя subject, на который пришло сообщение
* `reply-to`: опциональный reply-subject
* `#bytes`: размер payload в байтах
* `payload`: данные сообщения

## PING/PONG

### Описание

`PING` и `PONG` реализуют keep-alive между серверами. После установления соединения сервер NATS периодически отправляет `PING` другим серверам с настраиваемым интервалом. Если удаленный сервер не отвечает `PONG` в заданный интервал, соединение закрывается.

Если удаленный сервер отправляет `PING`, локальный сервер отвечает `PONG`, подтверждая свою доступность.

### Синтаксис

`PING\r` `PONG\r`

## -ERR

### Описание

`-ERR` используется сервером для индикации протокольной, авторизационной или иной runtime-ошибки удаленному серверу. Большинство таких ошибок приводит к закрытию соединения.

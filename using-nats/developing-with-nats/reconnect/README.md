# Автоматические переподключения

Все клиентские библиотеки, поддерживаемые на странице [nats.io GitHub](https://github.com/nats-io), автоматически пытаются переподключиться, если текущее соединение с сервером по любой причине разорвано. После переподключения клиентская библиотека автоматически восстанавливает все подписки, приложению не нужно ничего делать.

Если переподключения не [отключены](disable.md), клиент будет пытаться переподключиться к одному из известных серверов — либо из URL, переданных в `connect`, либо из URL, предоставленных системой NATS во время предыдущих подключений. Эта возможность позволяет приложениям NATS и самой системе NATS самовосстанавливаться и перенастраиваться без дополнительной конфигурации или вмешательства.

Вы можете настроить [время ожидания](wait.md) между попытками подключения, [максимальное](max.md) число попыток переподключения и размер [буфера](buffer.md) переподключения.

## Уведомления

Ваше приложение может зарегистрировать callback'и для получения [событий](events.md) о следующих событиях соединения:

* `ClosedCB ConnHandler`

Обработчик ClosedCB вызывается, когда клиент больше не будет подключаться.

* `DisconnectedCB ConnHandler`

Обработчик DisconnectedCB вызывается при каждом отключении. Он не будет вызван, если задан DisconnectedErrCB.
**УСТАРЕЛО**: используйте DisconnectedErrCB, который передаёт ошибку, вызвавшую событие отключения.

* `DisconnectedErrCB ConnErrHandler`

Обработчик DisconnectedErrCB вызывается при каждом отключении. Ошибка отключения может быть nil, например, когда пользователь явно закрывает соединение.
**ПРИМЕЧАНИЕ**: DisconnectedCB не будет вызван, если задан DisconnectedErrCB.

* `ReconnectedCB ConnHandler`

Обработчик ReconnectedCB вызывается при успешном переподключении.

* `DiscoveredServersCB ConnHandler`

Обработчик DiscoveredServersCB вызывается, когда к кластеру присоединяется новый сервер.

* `AsyncErrorCB ErrHandler`
  
Обработчик AsyncErrorCB вызывается при асинхронных ошибках соединения (например, ошибки медленного потребителя).

## Атрибуты таймаута соединения

* `Timeout time.Duration`

Timeout задаёт таймаут для операции Dial при подключении. По умолчанию `2 * time.Second`.
	
* `PingInterval time.Duration`

PingInterval — период, с которым клиент отправляет ping‑команды серверу; отключается, если 0 или отрицательное. По умолчанию `2 * time.Minute`.

* `MaxPingsOut int`

MaxPingsOut — максимальное число ожидающих ping‑команд, которые могут ждать ответа перед генерацией ошибки ErrStaleConnection. По умолчанию `2`.

## Атрибуты переподключения

Помимо упомянутых выше callback'ов ошибок и уведомлений, в опциях соединения можно задать несколько атрибутов переподключения:

* `AllowReconnect bool`

AllowReconnect включает логику переподключения при разрыве соединения с текущим сервером. По умолчанию `true`.

* `MaxReconnect int`

MaxReconnect задаёт число попыток переподключения, после которого попытки прекращаются. Если значение отрицательное, попытки не прекращаются. По умолчанию `60`.

* `ReconnectWait time.Duration`

ReconnectWait задаёт время ожидания после попытки (и неудачи) переподключения. По умолчанию `2 * time.Second`.

* `CustomReconnectDelayCB ReconnectDelayHandler`
  
CustomReconnectDelayCB вызывается после того, как библиотека попыталась подключиться ко всем URL в списке серверов и не смогла. Пользователю передаётся текущий счётчик попыток. Эта функция возвращает время, в течение которого библиотека будет спать перед следующей попыткой переподключения. Настоятельно рекомендуется добавлять некоторый jitter, чтобы все соединения не пытались переподключаться одновременно.

* `ReconnectJitter time.Duration`
  
ReconnectJitter задаёт верхнюю границу случайной задержки, добавляемой к *ReconnectWait* во время переподключения без TLS. Обратите внимание, что любой jitter ограничивается ReconnectJitterMax. По умолчанию `100 * time.Millisecond`.

* `ReconnectJitterTLS time.Duration`

ReconnectJitterTLS задаёт верхнюю границу случайной задержки, добавляемой к *ReconnectWait* во время переподключения с TLS. Обратите внимание, что любой jitter ограничивается ReconnectJitterMax. По умолчанию `1 * time.Second`.

* `ReconnectBufSize int`

ReconnectBufSize — размер буфера bufio при переподключении. После его исчерпания операции публикации будут возвращать ошибку. По умолчанию `8 * 1024 * 1024`.

* `RetryOnFailedConnect bool`

RetryOnFailedConnect переводит соединение в состояние переподключения сразу, если не удаётся подключиться к серверу из начального списка. Опции *MaxReconnect* и *ReconnectWait* используются для этого процесса так же, как при разрыве уже установленного соединения. Если задан ReconnectHandler, он будет вызван при первой успешной попытке переподключения (если начальное подключение не удалось), а если задан ClosedHandler, он будет вызван, если подключиться не удалось (после исчерпания MaxReconnect попыток). По умолчанию `false`.

# Номера последовательности

Частая проблема в сообщениях one‑to‑many — сообщение может быть потеряно из‑за сбоя сети. Простой паттерн для решения — включать в сообщение идентификатор последовательности. Получатели могут проверять sequence id, чтобы понять, не пропущено ли что‑то. Номера последовательности в сочетании с heartbeat‑ами, когда нет новых данных, образуют мощный и устойчивый паттерн для обнаружения потерь. Системы, которые хранят и персистентят сообщения, тоже решают эту проблему, но иногда это избыточно и обычно приводит к дополнительным затратам на управление и эксплуатацию.

![](../.gitbook/assets/seqno.svg)

Чтобы действительно использовать sequence id, важно помнить следующее:

* Каждый отправитель должен использовать свою собственную последовательность
* По возможности получатели должны иметь возможность запрашивать недостающие сообщения по id

В NATS можно встраивать sequence id в сообщение или включать их как токен в subject. Например, отправитель может отправлять сообщения на `updates.1`, `updates.2` и т. д., а подписчики могут слушать `updates.*` и парсить subject, чтобы определить sequence id. Размещение sequence‑токена в subject может быть предпочтительным, если payload неизвестен или невозможно встроить дополнительные данные (например, номер последовательности) в payload.

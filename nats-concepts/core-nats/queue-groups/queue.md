# Группы очередей

Когда подписчики регистрируются для получения сообщений от издателя, паттерн 1:N (fan‑out) гарантирует, что любое сообщение издателя достигнет всех зарегистрированных подписчиков. NATS предоставляет дополнительную возможность под названием "queue", которая позволяет подписчикам регистрироваться как часть очереди. Подписчики, входящие в очередь, образуют "queue group".

## Как работают группы очередей

Для примера рассмотрим доставку сообщений по паттерну 1:N всем подписчикам на основе имени subject (доставка происходит даже для подписчиков, которые не входят в группу очереди). Если подписчик зарегистрирован с именем очереди, он будет получать сообщения по своему subject. Однако если к тому же имени очереди добавляются другие подписчики, они образуют группу очереди, и при каждом получении сообщения группой очереди его обработает только один случайно выбранный подписчик. Такие распределенные очереди — это встроенная функция балансировки нагрузки в NATS.

**Преимущества**

* Обеспечивает отказоустойчивость приложений
* Обработку нагрузки можно масштабировать вверх или вниз
* Масштабируйте потребителей без дубликатов сообщений
* Не требуется дополнительная конфигурация
* Группы очередей определяются приложением и его подписчиками, а не конфигурацией сервера

Имена групп очередей подчиняются тем же правилам, что и [subjects](../../subjects.md). В первую очередь они чувствительны к регистру и не могут содержать пробелы. Рассмотрите возможность иерархического именования групп очередей с использованием точки `.`. Некоторые функции сервера, такие как [queue permissions](../../../running-a-nats-service/configuration/securing_nats/authorization.md#queue-permissions), могут использовать [wildcard‑сопоставление](../../subjects.md#wildcards) для них.

Подписчики очереди идеально подходят для масштабирования сервисов. Масштабирование вверх — это просто запуск еще одного приложения, а масштабирование вниз — завершение приложения с сигналом, который «осушит» in‑flight запросы. Эта гибкость и отсутствие необходимости менять конфигурацию делают NATS отличной технологией коммуникации сервисов, совместимой с любыми платформами.

### Нет обработчиков

Когда запрос отправляется сервису (request/reply) и сервер NATS знает, что нет доступных сервисов (поскольку нет клиентских приложений, подписанных на subject в группе очереди), сервер отправит запрашивающему клиенту протокольное сообщение “no-responders”, которое прервет блокирующий вызов API. Это позволяет приложениям реагировать мгновенно и помогает строить высокоотзывчивые системы в масштабе даже при сбоях приложений и сетевых разделениях.

## Stream как очередь

С [JetStream](../../jetstream/) поток можно использовать как очередь, установив политику хранения `WorkQueuePolicy` и используя [`pull` consumers](../../jetstream/consumers.md) для простой горизонтальной масштабируемости обработки (или используя явный ack push consumer с группой очереди подписчиков).

![](../../../.gitbook/assets/queue.svg)

### Гео‑аффинность очередей

При подключении к глобально распределенному супер‑кластеру NATS возникает автоматическая гео‑аффинность сервисов: сообщение запроса будет маршрутизировано в другой кластер (то есть другой регион) только если в локальном кластере нет слушателей, способных обработать запрос.

### Руководство

Попробуйте подписки с очередями в NATS самостоятельно, используя живой сервер, пройдя [пошаговое руководство по очередям](queues\_walkthrough.md).

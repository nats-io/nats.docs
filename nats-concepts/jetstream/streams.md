# Потоки

Streams — это хранилища сообщений. Каждый поток определяет, как сообщения хранятся и каковы лимиты хранения (время, размер, интерес). Потоки потребляют обычные [subjects NATS](../subjects.md); любое сообщение, опубликованное на этих subjects, будет захвачено в указанную систему хранения. Можно публиковать в subject обычным способом без подтверждения, но лучше использовать JetStream publish‑вызовы, поскольку JetStream сервер вернет подтверждение успешного сохранения.

![Orders](../../.gitbook/assets/streams-and-consumers-75p.png)

Диаграмма выше показывает идею хранения всех `ORDERS.*` в потоке, хотя существует много типов сообщений, связанных с заказами. Ниже мы покажем, как можно выборочно потреблять подмножества сообщений. Относительно прочих компонентов Stream — самый ресурсоемкий, поэтому возможность объединять связанные данные таким образом важно учитывать.

Потоки могут потреблять много subjects. Здесь у нас `ORDERS.*`, но мы также могли бы потреблять `SHIPPING.state` в тот же поток, если это имеет смысл.

## Лимиты потоков и хранение сообщений

Потоки поддерживают различные политики хранения, определяющие, когда сообщения в потоке могут быть автоматически удалены, например при достижении лимитов потока (максимальное количество, размер или возраст сообщений), а также более специфичные варианты поверх лимитов, такие как хранение по интересу или семантика очереди работ (см. [Retention Policy](#retentionpolicy)).

При достижении лимитов сообщений сервер автоматически отбрасывает сообщения, либо удаляя самые старые, чтобы освободить место для новых (`DiscardOld`), либо отказываясь хранить новые сообщения (`DiscardNew`). Подробнее см. [Discard Policy](#discardpolicy).

Потоки поддерживают дедупликацию с использованием заголовка `Nats-Msg-Id` и скользящего окна, в пределах которого отслеживаются дубликаты сообщений. См. раздел [Message Deduplication](../../using-nats/jetstream/model_deep_dive.md#message-deduplication).

Примеры настройки потоков в вашем клиенте NATS см. в [NATS by Example](https://natsbyexample.com).

## Конфигурация

Ниже приведен набор параметров конфигурации потока. Колонка `Version` показывает версию сервера, в которой опция была введена. Колонка `Editable` указывает, можно ли изменить опцию после создания потока. Примеры для клиентов см. [здесь](https://natsbyexample.com).

| Поле                                  | Описание                                                                                                                                                                                                                                                                                                | Version | Editable             |
|:--------------------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------|:---------------------|
| Name                                  | Идентифицирует поток и должен быть уникален в аккаунте JetStream. Имена не могут содержать пробелы, `.`, `*`, `>`, разделители пути (прямой или обратный слэш) и непечатаемые символы.                                                                                                              | 2.2.0   | No                   |
| [Storage](#storagetype)               | Тип хранения данных потока.                                                                                                                                                                                                                                                                              | 2.2.0   | No                   |
| [Subjects](#subjects)                 | Список subjects для привязки. Wildcards поддерживаются. Нельзя задавать для [mirror](#mirrors) потоков.                                                                                                                                                                                                   | 2.2.0   | Yes                  |
| Replicas                              | Сколько реплик хранить для каждого сообщения в кластерном JetStream, максимум 5.                                                                                                                                                                                                                        | 2.2.0   | Yes                  |
| MaxAge                                | Максимальный возраст любого сообщения в потоке, в наносекундах.                                                                                                                                                                                                                                          | 2.2.0   | Yes                  |
| MaxBytes                              | Максимальное число байтов, хранимых в потоке. Следует политике Discard, удаляя старые или отказывая новым сообщениям при превышении размера.                                                                                                                                                              | 2.2.0   | Yes                  |
| MaxMsgs                               | Максимальное число сообщений в потоке. Следует политике Discard, удаляя старые или отказывая новым сообщениям при превышении количества.                                                                                                                                                                  | 2.2.0   | Yes                  |
| MaxMsgSize                            | Максимальный размер сообщения, принимаемого потоком. Размер сообщения — сумма payload и заголовков.                                                                                                                                                                                                      | 2.2.0   | Yes                  |
| MaxConsumers                          | Максимальное число consumers, которое можно определить для потока, `-1` — без ограничений.                                                                                                                                                                                                               | 2.2.0   | No                   |
| NoAck                                 | По умолчанию `false`. Отключает подтверждения сообщений, полученных потоком. Это обязательно при архивировании сообщений с заданным reply subject, например запросов в Request/Reply. По умолчанию JetStream подтверждает каждое сообщение пустым ответом на reply subject.                               | 2.2.0   | Yes                  |
| [Retention](#retentionpolicy)         | Политика хранения потока.                                                                                                                                                                                                                                                                                | 2.2.0   | No                   |
| [Discard](#discardpolicy)             | Поведение при отбрасывании сообщений при достижении лимитов потока.                                                                                                                                                                                                                                      | 2.2.0   | Yes                  |
| DuplicateWindow                       | Окно, в пределах которого отслеживаются дубликаты сообщений, в наносекундах.                                                                                                                                                                                                                             | 2.2.0   | Yes                  |
| [Placement](#placement)               | Где размещать поток по тегам и/или явному имени кластера.                                                                                                                                                                                                                                                 | 2.2.0   | Yes                  |
| [Mirror](#mirrors)                    | Если задано, означает, что этот поток — зеркало другого потока.                                                                                                                                                                                                                                          | 2.2.0   | Yes (since 2.12.0)   |
| [Sources](#stream-sources)            | Если задано, объявляет один или несколько потоков, из которых этот поток будет забирать сообщения.                                                                                                                                                                                                        | 2.2.0   | Yes                  |
| MaxMsgsPerSubject                     | Ограничивает максимальное число сообщений в потоке _на один subject_.                                                                                                                                                                                                                                    | 2.3.0   | Yes                  |
| Description                           | Развернутое описание потока.                                                                                                                                                                                                                                                                             | 2.3.3   | Yes                  |
| Sealed                                | Запечатанные потоки не позволяют удалять сообщения через лимиты или API; снять запечатывание через обновление конфигурации нельзя. Можно установить только для уже созданных потоков через Update API.                                                                                                  | 2.6.2   | Yes (once)           |
| DenyDelete                            | Ограничивает возможность удалять сообщения из потока через API.                                                                                                                                                                                                                                          | 2.6.2   | No                   |
| DenyPurge                             | Ограничивает возможность очищать сообщения из потока через API.                                                                                                                                                                                                                                          | 2.6.2   | No                   |
| [AllowRollup](#allowrollup)           | Разрешает использовать заголовок `Nats-Rollup`, чтобы заменить все содержимое потока или subject в потоке одним новым сообщением.                                                                                                                                                                         | 2.6.2   | Yes                  |
| [RePublish](#republish)               | Если задано, сообщения, сохраненные в поток, будут немедленно _републикованы_ в указанный subject.                                                                                                                                                                                                       | 2.8.3   | Yes                  |
| AllowDirect                           | Если true и у потока больше одной реплики, каждая реплика отвечает на _direct get_ запросы отдельных сообщений, а не только лидер.                                                                                                                                                                        | 2.9.0   | Yes                  |
| MirrorDirect                          | Если true и поток является mirror, зеркало будет обслуживать _direct get_ запросы отдельных сообщений исходного потока.                                                                                                                                                                                  | 2.9.0   | Yes                  |
| DiscardNewPerSubject                  | Если true, применяет семантику discard new на уровне каждого subject. Требует `DiscardPolicy` = `DiscardNew` и заданный `MaxMsgsPerSubject`.                                                                                                                                                              | 2.9.0   | Yes                  |
| Metadata                              | Набор пар ключ‑значение, определенных приложением, для метаданных потока.                                                                                                                                                                                                                               | 2.10.0  | Yes                  |
| Compression                           | Если хранение на диске и задан алгоритм сжатия, данные потока будут сжаты на диске. Допустимые значения: пустая строка или `s2` (Snappy).                                                                                                                                                                | 2.10.0  | Yes                  |
| FirstSeq                              | Если задано, новый поток будет создан с начальным номером последовательности, равным этому значению.                                                                                                                                                                                                     | 2.10.0  | No                   |
| [SubjectTransform](#subjecttransform) | Применяет преобразование subject (к совпадающим сообщениям) перед сохранением.                                                                                                                                                                                                                           | 2.10.0  | Yes                  |
| ConsumerLimits                        | Задает лимиты по умолчанию для consumers потока. Их можно переопределить для каждого consumer.                                                                                                                                                                                                           | 2.10.0  | Yes                  |
| AllowMsgTTL                           | Если задано, разрешает TTL на сообщение через заголовки вместо опоры только на MaxAge.                                                                                                                                                                                                                   | 2.11.0  | No (can only enable) |
| SubjectDeleteMarkerTTL                | Если задано, после того как последнее сообщение subject «стареет», будет установлен маркер удаления subject. Это задает TTL маркера, который остается.                                                                                                                                                   | 2.11.0  | Yes                  |
| AllowAtomicPublish                    | Если задано, позволяет атомарно записывать в поток пакет из N сообщений.                                                                                                                                                                                                                                 | 2.12.0  | Yes                  |
| AllowMsgCounter                       | Если задано, поток будет работать как counter stream, размещая распределенные счетчики CRDT.                                                                                                                                                                                                             | 2.12.0  | No                   |
| AllowMsgSchedules                     | Если задано, позволяет планирование сообщений в потоке.                                                                                                                                                                                                                                                 | 2.12.0  | No (can only enable) |

### StorageType

Типы хранения включают:

- `File` (по умолчанию) — хранение данных потока на диске.
- `Memory` — хранение данных потока в памяти.

### Subjects

_Примечание: поток, настроенный как [mirror](#mirrors), не может иметь набор subjects. Зеркало неявно берет подмножество исходного потока (опционально с фильтром), но не подписывается на дополнительные subjects._

Если явный subject не задан, по умолчанию используется имя потока. Можно указать несколько subjects и изменять их со временем. Обратите внимание: если сообщения были сохранены потоком на subject, который позже удалили из конфигурации потока, consumers все равно будут видеть эти сообщения, если их фильтр subjects пересекается.

### RetentionPolicy

Варианты хранения:

- `LimitsPolicy` (по умолчанию) — хранение на основе заданных лимитов, включая `MaxMsgs`, `MaxBytes`, `MaxAge` и `MaxMsgsPerSubject`. Если задано несколько лимитов, применяется тот, который достигнут первым, и соответствующие сообщения автоматически удаляются. См. [пример кода][limits-example].
- `WorkQueuePolicy` — хранение с типичным поведением FIFO‑очереди. Каждое сообщение может быть потреблено только один раз. Это обеспечивается тем, что для work‑queue потока разрешается создать только _одного_ consumer _на subject_ (то есть фильтры subjects consumers не должны пересекаться). После ack сообщения оно удаляется из потока. См. [пример кода][workqueue-example].
- `InterestPolicy` — хранение на основе _интереса_ consumers к потоку и сообщениям. Базовый случай: для потока не определено ни одного consumer. Если сообщения публикуются в поток, они немедленно удаляются, так как интереса нет. Это означает, что consumers нужно привязывать к потоку до публикации сообщений. Когда сообщение ack‑ается _всеми_ consumers, фильтрующими subject, оно удаляется (то же поведение, что и `WorkQueuePolicy`). См. [пример кода][interest-example].

{% hint style="warning" %}
Если для потока выбрана `InterestPolicy` или `WorkQueuePolicy`, имейте в виду, что любые заданные лимиты все равно применяются. Например, для work‑queue потока при установленном `MaxMsgs` и политике discard _old_ сообщения будут автоматически удаляться, даже если consumer их не получил.
{% endhint %}

{% hint style="info" %}
Если выбрана `InterestPolicy`, учитывайте, что при удалении consumer (вручную или при очистке сервером, когда достигается `InactiveThreshold`), и если этот consumer был последним, кто отмечал интерес к набору subjects, сервер может не удалить все сообщения из этого набора немедленно по причинам производительности. Вместо этого удаление может быть отложено до тех пор, пока сообщения не достигнут начала потока.
{% endhint %}

{% hint style="info" %}
Потоки с `WorkQueuePolicy` удаляют сообщения только по лимитам или после успешного `Ack` от consumer. Сообщения, которые пытались переотправить и достигли `MaxDeliver` попыток для consumer, останутся в потоке и должны быть удалены вручную через JetStream API.
{% endhint %}

[limits-example]: https://natsbyexample.com/examples/jetstream/limits-stream/go
[interest-example]: https://natsbyexample.com/examples/jetstream/interest-stream/go
[workqueue-example]: https://natsbyexample.com/examples/jetstream/workqueue-stream/go

### DiscardPolicy

Поведение discard применяется только к потокам, у которых задан хотя бы один лимит. Варианты:

- `DiscardOld` (по умолчанию) — эта политика удаляет самые старые сообщения, чтобы соблюдать лимит. Например, если `MaxAge` равен одной минуте, сервер автоматически удалит сообщения старше одной минуты.
- `DiscardNew` — эта политика отвергает _новые_ сообщения, если их добавление _превысит_ один из лимитов. Расширение этой политики — `DiscardNewPerSubject`, которая применяет это поведение на уровне каждого subject внутри потока.

### Placement

Относится к размещению активов потока (данных) внутри развертывания NATS — будь то один кластер или супер‑кластер. Конкретный поток, включая все реплики (но не зеркала), привязан к одному кластеру. Поэтому при создании или переносе потока выбирается кластер, который будет хранить эти активы.

Если явное размещение потока не задано, по умолчанию поток создается в кластере, к которому подключен клиент, при условии, что там достаточно хранилища.

Задавая размещение потока, можно явно контролировать, где будут находиться активы. Это обычно полезно для совместного размещения с самыми активными клиентами (издателями или consumers) либо может требоваться по причинам суверенитета данных.

Placement поддерживается во всех SDK клиентов и в CLI. Например, добавление потока через CLI для размещения в конкретном кластере выглядит так:

```
nats stream add --cluster aws-us-east1-c1
```

Чтобы это работало, все серверы в данном кластере должны иметь поле `name` в блоке конфигурации сервера [`cluster`][cluster-config].

```
cluster {
  name: aws-us-east1-c1
  # etc..
}
```

Если у вас несколько кластеров, образующих супер‑кластер, каждый из них должен иметь уникальное имя.

Другой вариант размещения — _tags_. Каждый сервер может иметь свой набор тегов, [заданный в конфигурации][tag-config], обычно описывающий географию, хостинг‑провайдера, размерный класс и т. п. Кроме того, теги часто используются вместе с опцией `jetstream.unique_tag`, чтобы гарантировать, что реплики размещаются на серверах с _разными_ значениями тега.

Например, серверы A, B и C в указанном кластере могут иметь одинаковую конфигурацию, кроме зоны доступности, в которой они развернуты.

```
// Server A
server_tags: ["cloud:aws", "region:us-east1", "az:a"]

jetstream: {
  unique_tag: "az"
}

// Server B
server_tags: ["cloud:aws", "region:us-east1", "az:b"]

jetstream: {
  unique_tag: "az"
}

// Server C
server_tags: ["cloud:aws", "region:us-east1", "az:c"]

jetstream: {
  unique_tag: "az"
}
```

Теперь мы можем создать поток, используя теги, например указав, что хотим поток в us‑east1.

```
nats stream add --tag region:us-east1
```

Если у нас есть второй кластер в Google Cloud с тем же тегом региона, поток может быть размещен либо в AWS, либо в GCP. Однако ограничение `unique_tag` гарантирует, что каждая реплика будет размещена в другой AZ в кластере, выбранном по тегам размещения.

Хотя это встречается реже, размещение может использовать и кластер, и теги одновременно. Это актуально, если в одном кластере есть серверы с разными свойствами.

[cluster-config]: https://docs.nats.io/running-a-nats-service/configuration/clustering/cluster_config
[tag-config]: https://docs.nats.io/running-a-nats-service/configuration#cluster-configuration-monitoring-and-tracing

### Sources и Mirrors

Когда поток настроен с `source` или `mirror`, он автоматически и асинхронно реплицирует сообщения из исходного потока. При объявлении конфигурации доступно несколько опций.

Поток‑источник или зеркало могут иметь собственные политику хранения, репликацию и тип хранения. Изменения источника или зеркала, например удаление сообщений или публикации, не отражаются на исходном потоке.


{% hint style="info" %}
`Sources` — это обобщение `Mirror` и позволяет одновременно забирать данные из одного или нескольких потоков. Мы рекомендуем использовать `Sources` в новых конфигурациях.
Если вам нужно, чтобы целевой поток был репликой только для чтения:
- Настройте поток без listen subjects **или**
- Временно отключите listen subjects через авторизации клиента.
{% endhint %}

#### Stream sources

Поток с `Sources` — это обобщенный механизм репликации, который позволяет одновременно получать данные из одного или нескольких потоков, а также разрешает прямую запись/публикацию клиентами. По сути, исходные потоки и записи клиентов агрегируются в один «перемешанный» поток. Преобразование и фильтрация subjects позволяют строить мощные архитектуры распределения данных.

#### Mirrors

Зеркало может брать сообщения ровно из одного потока, и клиенты не могут напрямую писать в зеркало. Хотя публиковать сообщения в зеркало напрямую нельзя, сообщения можно удалять по запросу (вне политики хранения), и consumers имеют все возможности, доступные на обычных потоках.

**Подробнее:**
* [Source and Mirror](source_and_mirror.md)


### AllowRollup

Если включено, опция потока `AllowRollup` позволяет публиковать сообщение с заголовком `Nats-Rollup`, указывающим, что все предыдущие сообщения должны быть очищены. Область _purge_ определяется значением заголовка: `all` или `sub`.

Заголовок `Nats-Rollup: all` очищает все предыдущие сообщения в потоке. Значение `sub` очищает все предыдущие сообщения для заданного subject.

Типичный сценарий rollup — снимки состояния, когда публикуемое сообщение содержит всё необходимое состояние, накопленное из предыдущих сообщений относительно потока или конкретного subject.

### RePublish

Если включено, опция `RePublish` приводит к тому, что сервер автоматически и сразу после успешной записи повторно публикует сообщения, полученные в поток, в отдельный целевой subject.

Для сценариев с высокой нагрузкой, где выделенный consumer создает слишком большой overhead, клиенты могут подписаться в core NATS на целевой subject и получать сообщения, добавленные в поток, в реальном времени.

Поля конфигурации republish:

- `Source` — необязательный шаблон subject, являющийся подмножеством subjects, привязанных к потоку. По умолчанию — все сообщения в потоке, например `>`.
- `Destination` — subject назначения, куда будут перепубликовываться сообщения. Источник и назначение должны соответствовать допустимому [subject mapping](../../nats-concepts/subject_mapping.md).
- `HeadersOnly` — если true, данные сообщения не будут включены в перепубликуемое сообщение; добавляется только заголовок `Nats-Msg-Size`, указывающий размер сообщения в байтах.

Для каждого перепубликуемого сообщения автоматически добавляется набор [заголовков](./headers.md).

**Примечание:** `reply-subject` удаляется из перепубликуемых сообщений, даже если в потоке задан `no-ack`.

### SubjectTransform

Если настроено, `SubjectTransform` выполнит преобразование subject для совпадающих subjects сообщений, полученных потоком, и преобразует subject перед сохранением сообщения в поток. Конфигурация преобразования задает поля `Source` и `Destination` по правилам [subject transform](../../running-a-nats-service/configuration/configuring_subject_mapping.md).

# Потоки Source и Mirror

Когда поток настроен с `source` или `mirror`, он автоматически и асинхронно реплицирует сообщения из исходного потока.

`source` и `mirror` спроектированы как надежные и восстанавливаются после потери соединения. Они подходят для геораспределения в условиях высокой задержки и нестабильных соединений. Например, даже leaf node, который запускается и подключается раз в несколько дней, будет получать или отправлять сообщения через связь source/mirror.\
Еще один сценарий — [соединение потоков между аккаунтами](../../running-a-nats-service/configuration/securing_nats/accounts.md#exporting-and-importing).

При объявлении конфигурации доступны следующие параметры:

* `Name` — имя исходного потока, из которого брать сообщения.
* `StartSeq` — необязательная стартовая последовательность исходного потока, с которой начинать зеркалирование.
* `StartTime` — необязательное время начала, с которого начинать зеркалирование. Любые сообщения, равные или позже этого времени, будут включены.
* `FilterSubject` — необязательный фильтр subject, который включает только совпадающие сообщения, обычно с wildcard. Обратите внимание: нельзя использовать вместе с `SubjectTransforms`.
* `SubjectTransforms` — необязательный набор [преобразований subjects](../../running-a-nats-service/configuration/configuring_subject_mapping.md), применяемых при источнике сообщений из исходного потока. В этом контексте `Source` действует как фильтр исходного потока, а `Destination` может быть задан для преобразования. Так как можно использовать несколько преобразований, можно забирать непересекающиеся subjects из исходного потока, сохраняя порядок сообщений. Обратите внимание: нельзя использовать вместе с `FilterSubject`.
* `Domain` — необязательный домен JetStream, в котором находится исходный поток. Обычно используется в топологиях hub‑cluster и leafnode.

Поток, использующий source или mirror, может иметь собственную политику хранения, репликацию и тип хранения.

{% hint style="info" %}
* Изменения потока с source или mirror (например, удаление сообщений или публикации) не отражаются обратно на исходном потоке, из которого получены данные.
* Удаления в исходном потоке НЕ реплицируются через соглашение `source` или `mirror`.
{% endhint %}

{% hint style="info" %}
`Sources` — это обобщение `Mirror` и позволяет одновременно получать данные из одного или нескольких потоков.\
Если вам нужно, чтобы целевой поток работал как реплика только для чтения:

* Настройте поток без listen subjects **или**
* Временно отключите listen subjects через авторизации клиента.
{% endhint %}

## Общие особенности

* Все конфигурации задаются на принимающей стороне. Поток, из которого берутся и зеркалируются данные, не требует настройки. Если приемник исчезает, на стороне источника ничего чистить не нужно.
* Один поток может быть источником для нескольких потоков. Это полезно для геораспределения или для построения топологий "fan out", где данные нужно надежно распределять на большое число (до миллионов) клиентских соединений.
* Leaf nodes и домены leaf node явно поддерживаются через `API prefix`.

## Специфика Source

Поток с `Sources` — это обобщенный механизм репликации, который позволяет одновременно получать данные из **одного или нескольких потоков**. Поток с sources может оставаться обычным потоком и позволять прямую запись/публикацию локальными клиентами. По сути, исходные потоки и записи локальных клиентов агрегируются в один перемешанный поток.\
В сочетании с преобразованием и фильтрацией subjects это позволяет строить сложные архитектуры распределения данных.

{% hint style="info" %}
При источнике сообщений номера последовательности не сохраняются. Однако сохраняется порядок сообщений внутри потока. Между потоками, которые источаются в один и тот же целевой поток, порядок сообщений не определен.
{% endhint %}

## Специфика Mirror

Зеркало может получать сообщения **ровно из одного потока**, и клиенты не могут напрямую писать в зеркало. Хотя публиковать сообщения в зеркало напрямую нельзя, сообщения можно удалять по запросу (за пределами политики хранения), и consumers имеют все возможности, доступные в обычных потоках.

{% hint style="info" %}
* Зеркальные сообщения сохраняют номера последовательности и временные метки исходного потока.
* Зеркала можно использовать для (географического) распределения нагрузки с атрибутом потока `MirrorDirect`. См.: [https://docs.nats.io/nats-concepts/jetstream/streams#configuration](https://docs.nats.io/nats-concepts/jetstream/streams#configuration)
{% endhint %}

## Ожидаемое поведение в граничных условиях

* Контракты source и mirror рассчитаны на одностороннюю (географическую) репликацию данных. Ни одна конфигурация не обеспечивает полную синхронизацию между потоками, которая включала бы удаления или репликацию других атрибутов потока.
* Содержимое исходного потока для source/mirror должно быть достаточно стабильным. Быстрое удаление сообщений после публикации может привести к неконсистентной репликации из‑за асинхронной природы процесса.
* Source и Mirror стремятся эффективно реплицировать сообщения и терпимо относятся к недоступности источника (даже на продолжительное время), например при использовании leaf nodes с периодическими подключениями. Ради эффективности интервал восстановления после разрыва составляет 10–20 секунд.
* Соглашения mirror и source не создают видимого consumer в исходном потоке.

### WorkQueue retention

Source и Mirror работают с исходным потоком с workqueue‑хранением в ограниченном контексте. Source/mirror будет выступать потребителем, удаляющим сообщения из исходного потока.

Однако реализация неустойчива при подключениях через периодически доступные leaf nodes. Внутри кластера, где расположен целевой поток (с соглашением source/mirror), это обычно работает хорошо.

{% hint style="warning" %}
Source и mirror для потоков с workqueue‑хранением поддерживаются лишь частично. Они неустойчивы к потерям соединения через leaf nodes.

Consumer, вытягивающий сообщения из удаленного потока, не является durable, и другие клиенты могут потреблять и удалять сообщения из workqueue, пока соединение leaf недоступно.
{% endhint %}

{% hint style="warning" %}
Если вы попытаетесь создать дополнительные (конфликтующие) consumers в исходном workqueue‑потоке, поведение будет неопределенным. Workqueue допускает только одного consumer на subject. Если соединение source/mirror активно, локальные клиенты, пытающиеся создать дополнительные consumers, получат ошибку. И наоборот, source/mirror нельзя создать, если уже есть локальный consumer для тех же subjects.
{% endhint %}

### Interest base retention

{% hint style="warning" %}
Source и mirror для потоков с interest‑хранением не поддерживаются. JetStream не запрещает эту конфигурацию, но поведение неопределено и может измениться в будущем.
{% endhint %}

# Заголовки

Заголовки сообщений используются в разных контекстах JetStream, таких как дедупликация, авто‑очистка сообщений, метаданные перепубликованных сообщений и др.

`Nats-` — зарезервированное пространство имен. Пожалуйста, используйте другой префикс для своих заголовков. Этот список может быть неполным. Дополнительные заголовки могут использоваться для внутренних сообщений API или сообщений мониторинга и управления.

## Publish

Заголовки, которые клиент может установить при публикации сообщения. Эти заголовки распознаются сервером.

| Name                                  | Description                                                                                                                                                                                                       | Example                                | Version |
|:----------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------|
| `Nats-Msg-Id`                         | Уникальный идентификатор сообщения, заданный клиентом, который сервер использует для дедупликации в пределах настроенного `Duplicate Window`.                                                                     | `9f01ccf0-8c34-4789-8688-231a2538a98b` | 2.2.0   |
| `Nats-Expected-Stream`                | Используется, чтобы проверить, что опубликованное сообщение попало в ожидаемый поток.                                                                                                                            | `my-stream`                            | 2.2.0   |
| `Nats-Expected-Last-Msg-Id`           | Используется для оптимистичного контроля конкурентности на уровне потока. Значение — последний ожидаемый `Nats-Msg-Id`; сервер отклонит публикацию, если текущий ID не совпадает.                                  | `9f01ccf0-8c34-4789-8688-231a2538a98b` | 2.2.0   |
| `Nats-Expected-Last-Sequence`         | Используется для оптимистичного контроля конкурентности на уровне потока. Значение — последняя ожидаемая последовательность; сервер отклонит публикацию, если текущая последовательность не совпадает.             | `328`                                  | 2.2.0   |
| `Nats-Expected-Last-Subject-Sequence` | Используется для оптимистичного контроля конкурентности на уровне subject. Значение — последняя ожидаемая последовательность; сервер отклонит публикацию, если последовательность не совпадает для subject сообщения. | `38`                                   | 2.3.1   |
| `Nats-Expected-Last-Subject-Sequence-Subject` | Subject (может содержать wildcards). Используется с `Nats-Expected-Last-Subject-Sequence`. Сервер будет проверять последовательность по указанному subject, а не по публикуемому.                                   | `events.orders.1.>`                                                                 | 2.11.0  |
| `Nats-Rollup`                         | Используется для очистки всех предыдущих сообщений в потоке или на уровне subject. Сообщение‑rollup останется в потоке. Требует включенного allow rollups в потоке.                                              | `all` очищает весь поток, `sub` очищает subject, на который отправлено сообщение. Wildcards в subjects не допускаются и приводят к неопределенному поведению. | 2.6.2   |
| `Nats-TTL`   |   Используется для задания TTL на сообщение. Требует включенного per‑message TTL для потока.   | `1h`, `10s` (формат длительности Go)  | 2.11   |

## RePublish или direct get

Когда сообщения перепубликуются (нужно включить в настройках потока) из потока или извлекаются через direct get, устанавливаются следующие заголовки.

Не задавайте эти заголовки в клиентских публикациях.

| Name                 | Description                                                                                                            | Example                       | Version |
| :------------------- | :--------------------------------------------------------------------------------------------------------------------- | :---------------------------- | :------ |
| `Nats-Stream`        | Имя потока, из которого сообщение было перепубликовано.                                                                | `Nats-Stream: my-stream`      | 2.8.3   |
| `Nats-Subject`       | Исходный subject сообщения.                                                                                            | `events.mouse_clicked`        | 2.8.3   |
| `Nats-Sequence`      | Исходная последовательность сообщения.                                                                                 | `193`                         | 2.8.3   |
| `Nats-Last-Sequence` | Последняя последовательность сообщения с тем же subject, или ноль, если это первое сообщение для subject.             | `190`                         | 2.8.3   |
| `Nats-Time-Stamp`    | Исходная временная метка сообщения.                                                                                    | `2023-08-23T19:53:05.762416Z` | 2.10.0  |
| `Nats-Num-Pending`   | Число сообщений, ожидающих в ответе multi/batched get. Подробнее: [ADR-31](https://github.com/nats-io/nats-architecture-and-design/blob/main/adr/ADR-31.md)                                                | `5` | 2.10.0  |
| `Nats-UpTo-Sequence` | В последнем сообщении multi/batched get ответа. Значение `up-to-seq` исходного запроса. Помогает клиенту продолжить незавершенные batch‑запросы. Подробнее: [ADR-31](https://github.com/nats-io/nats-architecture-and-design/blob/main/adr/ADR-31.md) |  | 2.11.0  |

## Sources

Заголовки, которые неявно добавляются к сообщениям, полученным из других потоков.

Формат содержимого заголовка может измениться в будущем. Парсите консервативно и учитывайте, что могут появиться дополнительные поля, а в старых версиях nats-server полей может быть меньше.

| Name                 | Description                                                                                                                                           | Example     | Version |
| :------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------- | :---------- | :------ |
| `Nats-Stream-Source` | Содержит, разделенные пробелами:<br> - имя исходного потока (с хешем домена при источнике из другого домена)<br> - исходный номер последовательности<br> - список фильтров subjects<br> - список преобразований назначения<br> - исходный subject<br>  | `ORDERS:vSF0ECo6 17 foo.* bar.$1 foo.abc` | 2.2.0   |

## Tracing

При включенном tracing каждый подсистемный компонент, касающийся сообщения, будет создавать Trace Events. Эти события агрегируются на сервере и публикуются в целевой subject.

Существуют два варианта: `traceparent` по стандарту trace context и ad hoc tracing через `Nats-Trace-Dest`.

Введено в версии 2.11 — см. [ADR-41](https://github.com/nats-io/nats-architecture-and-design/blob/main/adr/ADR-41.md)

| Name            | Description                          | Example | Version |
| :-------------- | :----------------------------------- | :------ | :------ |
| `traceparent` | Включает tracing согласно стандарту [https://www.w3.org/TR/trace-context/](https://www.w3.org/TR/trace-context/). Требует настройки секции `msg-trace` на уровне аккаунта. | N/A | 2.11   |
| `Nats-Trace-Dest` |  Subject, который будет получать trace‑сообщения.  | trace.receiver.all | 2.11   |
| `Nats-Trace-Only` | Опционально. По умолчанию `false`. Установите `true`, чтобы пропустить доставку сообщения. В этом случае будут создаваться только trace‑сообщения, а сообщение не будет отправлено подписчику или сохранено в JetStream. | `true` | 2.11   |
| `Accept-Encoding` | Опционально. Включает сжатие payload trace‑сообщений.  | `gzip`, `snappy` | 2.11   |
| `Nats-Trace-Hop` | Внутренний. **Не задавать**. Устанавливается сервером для подсчета хопов.  | `<hop count>` | 2.11   |
| `Nats-Trace-Origin-Account` | Внутренний. **Не задавать**. Устанавливается сервером при пересечении границы аккаунта.  | `<account name>` | 2.11   |

## Scheduler

Планирование сообщений в потоках. Требует включения флага "allow schedules" в потоке.

Введено в версии 2.11 — см. [ADR-51](https://github.com/nats-io/nats-architecture-and-design/blob/main/adr/ADR-51.md)

| Name            | Description                          | Example | Version |
| :-------------- | :----------------------------------- | :------ | :------ |
| `Nats-Schedule` | Когда сообщение будет отправлено в целевой subject. Поддерживаются форматы: timestamp для одноразовой отправки, crontab для повторяющихся сообщений и короткие алиасы для типичных crontab‑форматов. | `0 30 14 * * *`, `@hourly`, `daily`, `@at 2009-11-10T23:00:00Z` (формат RFC3339)   | 2.11   |
| `Nats-Schedule-TTL` | Опционально. TTL для финального сообщения в целевом subject. | `1h`, `10s` (валидный формат длительности Go) | 2.11  |
| `Nats-Schedule-Target` | Целевой subject, в который будет отправлено финальное сообщение. Он должен отличаться от scheduling subject, в который пришло сообщение. | `orders`  | 2.11  |
| `Nats-Schedule-Source` | Опционально. Указывает scheduler прочитать последнее сообщение по заданному subject и опубликовать его. Если Subject пуст, ничего не публикуется; wildcards не поддерживаются. | `orders.customer_acme`  | 2.11  |
| `Nats-Schedule-Time-Zone` | Опционально. Временная зона для Cron‑расписания. Если не указано, Cron будет в UTC. Нельзя использовать, если расписание не является Cron. | `CET`  | 2.11  |

Финальное запланированное сообщение будет содержать следующие заголовки:

| Name            | Description                          | Example | Version |
| :-------------- | :----------------------------------- | :------ | :------ |
| `Nats-Scheduler` | Subject, который держит расписание | `orders.schedule.1234`  | 2.11   |
| `Nats-Schedule-Next` | Timestamp следующего запуска для cron‑сообщений или момент purge для отложенных сообщений | `2009-11-10T23:00:00Z` | 2.11  |
| `Nats-TTL` | Значение TTL, когда был задан `Nats-Schedule-TTL` | `1h`, `10s`  | 2.11  |

##

## Batch send

Введено в версии 2.12 с оптимизациями в 2.14 — см. [ADR-50](https://github.com/nats-io/nats-architecture-and-design/blob/main/adr/ADR-50.md)

Атомарные batch‑отправки используют следующие заголовки. Batch атомарен только на отправке, но клиент может восстановить batch по заголовкам ниже.

| Name            | Description                          | Example | Version |
| :-------------- | :----------------------------------- | :------ | :------ |
| `Nats-Batch-Id` | Уникальный идентификатор batch. | `<uuid>` (<=64 символов)  | 2.12   |
| `Nats-Batch-Sequence` | Монотонно возрастающий идентификатор, начиная с `1` | `1`, `2` | 2.12   |
| `Nats-Batch-Commit` | Только в последнем сообщении. `1` коммитит batch включая это сообщение. `eob` коммитит batch, исключая это сообщение. Любое другое значение прерывает batch. | `1`, `eob`   | 2.12   |

## Internal

Заголовки, используемые внутренними API‑клиентами и сервером. Пользователю задавать не следует.

Этот список не исчерпывающий. Заголовки, используемые в ответах с ошибками, могут быть не документированы.

| Name            | Description                          | Example | Version |
| :-------------- | :----------------------------------- | :------ | :------ |
| `Nats-Required-Api-Level` | Опционально. Требуемый уровень API для запроса JetStream. Серверы начиная с версии 2.11 вернут ошибку, если значение выше поддерживаемого уровня API. | `2` (целое число) | 2.11  |
| `Nats-Request-Info` |  При пересечении границ аккаунтов может добавляться заголовок с информацией об источнике (аккаунт, пользователь и т. д.). |  | 2.2.0  |
| `Nats-Marker-Reason` |  Когда сообщения удаляются из KV, где поддерживаются delete markers, устанавливается маркер удаления и отправляются уведомления наблюдателям. Payload сообщения пустой, а причина удаления указывается в этом заголовке. См. [ADR-48](https://github.com/nats-io/nats-architecture-and-design/blob/main/adr/ADR-48.md)  | `MaxAge`, `Remove`, `Purge` | 2.12  |
| `Nats-Incr` | Используется в KV stores для атомарного инкремента счетчика. Любое целое число (включая 0) со знаком. См. [ADR-49](https://github.com/nats-io/nats-architecture-and-design/blob/main/adr/ADR-49.md)  | `+1`, `+42`, `-1`, `+0`  | 2.12  |
| `Nats-Counter-Sources` | Отслеживание `Nats-Incr` при источнике сообщений. Подробнее см.: [ADR-49](https://github.com/nats-io/nats-architecture-and-design/blob/main/adr/ADR-49.md)  |  | 2.12  |

Nats-Counter-Sources

## Mirror

Заголовки, используемые для внутренних сообщений контроля потока для зеркала.

Только для информации и может меняться без уведомления.

| Name                    | Description | Example | Version |
| :---------------------- | :---------- | :------ | :------ |
| `Nats-Last-Consumer`    |             |         | 2.2.1   |
| `Nats-Last-Stream`      |             |         | 2.2.1   |
| `Nats-Consumer-Stalled` |             |         | 2.4.0   |
| `Nats-Response-Type`    |             |         | 2.6.4   |

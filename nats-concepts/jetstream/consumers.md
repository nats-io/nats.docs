# Потребители

Consumer — это состояние **view** потока. Он служит интерфейсом для клиентов, чтобы _потреблять_ подмножество сообщений, хранящихся в потоке, и отслеживает, какие сообщения были доставлены и подтверждены клиентами.

В отличие от [Core NATS](https://docs.nats.io/nats-concepts/core-nats), где гарантия доставки «не более одного раза», consumer в JetStream может обеспечивать доставку **как минимум один раз**.

Пока **Streams** отвечают за хранение опубликованных сообщений, consumer отвечает за отслеживание доставки и подтверждений. Это отслеживание гарантирует, что если сообщение не подтверждено (un‑acked или 'nacked'), consumer автоматически попробует доставить его повторно. Consumers JetStream поддерживают различные типы и политики подтверждений. Если сообщение не подтверждено в пределах заданного пользователем числа попыток доставки, генерируется advisory‑уведомление.

## Тип доставки — Pull / Push

Consumers могут быть **push**‑типа, когда сообщения доставляются на заданный subject, или **pull**‑типа, когда клиенты запрашивают пакеты сообщений по требованию. Выбор типа consumer зависит от сценария.

Если нужно обрабатывать сообщения под контролем приложения и легко масштабироваться горизонтально, используйте pull consumer. Если простому приложению нужен последовательный replay сообщений потока, используйте ordered push consumer. Если приложению нужна балансировка нагрузки или индивидуальные подтверждения сообщений, используйте обычный push consumer.

{% hint style="info" %}Рекомендуем pull consumers для новых проектов, особенно когда важны масштабируемость, детальный контроль потока или обработка ошибок.{% endhint %}

### Ordered Consumers

Ordered consumers — удобный тип по умолчанию для push и pull consumers, предназначенный для приложений, которые хотят эффективно потреблять поток для инспекции данных или анализа.
* Всегда ephemeral
* Без подтверждений (при обнаружении разрыва consumer пересоздается)
* Автоматический контроль потока / обработка pull
* Однопоточная доставка
* Без балансировки нагрузки

## Персистентность — Durable / Ephemeral

Помимо выбора push или pull, consumer может быть **ephemeral** или **durable**. Consumer считается _durable_, когда задано явное имя в поле `Durable` при создании consumer, или когда задан `InactiveThreshold`.

Durable и ephemeral имеют одинаковую семантику доставки сообщений, но ephemeral consumer не имеет персистентного состояния или отказоустойчивости (только память сервера) и автоматически _очищается_ (удаляется) после периода неактивности, когда к consumer не привязаны подписки.

По умолчанию consumers имеют такой же коэффициент репликации, как поток, который они потребляют, и сохраняются даже при периодах неактивности (если `InactiveThreshold` не задан явно). Consumers могут восстанавливаться после сбоев сервера и клиента.

{% embed url="https://youtu.be/334XuMma1fk" %} NATS JS Consumers - The ONE feature that makes NATS more powerful than Kafka, Pulsar, RabbitMQ, & redis
{% endembed %}

## Конфигурация

Ниже приведен набор параметров конфигурации consumer. Колонка `Version` указывает версию nats-server, в которой опция была введена. Колонка `Editable` указывает, можно ли изменить опцию после создания consumer.

### General

| Field             | Description                                                                                                                                                                                                                                                                                                                                 | Version | Editable |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- | -------- |
| Durable           | Если задано, клиенты могут привязывать подписки к consumer и _возобновлять_ работу до тех пор, пока consumer явно не удален. Имя durable не может содержать пробелы, `.`, `*`, `>`, разделители пути (прямой или обратный слэш) и непечатаемые символы.                                                                                | 2.2.0   | No       |
| [FilterSubject](#filtersubjects)  | Subject, пересекающийся с subjects потока, для фильтрации доставки подписчикам. Примечание: нельзя использовать вместе с `FilterSubjects`.                                                                                                                                                                                                       | 2.2.0   | Yes      |
| [AckPolicy](#ackpolicy) | Требования к подтверждениям клиента: `AckExplicit`, `AckNone` или `AckAll`.                                                                                                                                                                                                                                                                   | 2.2.0   | No       |
| AckWait           | Время ожидания подтверждения для отдельного сообщения _после его доставки consumer_. Если подтверждение не получено вовремя, сообщение будет переотправлено. Эта настройка действует только если `BackOff` **не задан**.                                                                                                                     | 2.2.0   | Yes      |
| [DeliverPolicy](#deliverpolicy) | Точка в потоке, с которой получать сообщения: `DeliverAll`, `DeliverLast`, `DeliverNew`, `DeliverByStartSequence`, `DeliverByStartTime` или `DeliverLastPerSubject`.                                                                                                                                                                              | 2.2.0   | No       |
| OptStartSeq       | Используется с политикой `DeliverByStartSequence`.                                                                                                                                                                                                                                                                                            | 2.2.0   | No       |
| OptStartTime      | Используется с политикой `DeliverByStartTime`.                                                                                                                                                                                                                                                                                                | 2.2.0   | No       |
| Description       | Описание consumer. Это особенно полезно для ephemeral consumers, чтобы указать их назначение, поскольку имя durable задать нельзя.                                                                                                                                                                                                             | 2.3.3   | Yes      |
| InactiveThreshold | Длительность, по истечении которой сервер удаляет неактивные consumers. До версии 2.9 это применялось только к ephemeral consumers.                                                                                                                                                                                                           | 2.2.0   | Yes      |
| [MaxAckPending](#maxackpending) | Определяет максимальное число сообщений без подтверждения, которые могут быть «в ожидании». При достижении лимита доставка сообщений приостанавливается. Лимит применяется ко _всем_ подпискам, привязанным к consumer. Значение -1 означает отсутствие лимита. По умолчанию 1000.                                                            | 2.2.0   | Yes      |
| MaxDeliver        | Максимальное число попыток доставки конкретного сообщения. Применяется к сообщениям, переотправленным из‑за политики подтверждений (например, при отрицательном подтверждении или отсутствии подтверждения). По умолчанию -1 (переотправлять до подтверждения). Сообщения, достигшие максимума, остаются в потоке.                         | 2.2.0   | Yes      |
| Backoff           | Последовательность задержек, управляющих переотправкой при тайм‑ауте подтверждения (но не при `nak`). Длина списка должна быть меньше или равна `MaxDeliver`. Если backoff не задан, тайм‑аут приводит к немедленной переотправке. Например, `MaxDeliver=5` `backoff=[5s, 30s, 300s, 3600s, 84000s]` переотправит сообщение 5 раз за день. Когда `MaxDeliver` больше длины списка, последняя задержка применяется к оставшимся доставкам. Backoff НЕ применяется к `nak`‑сообщениям. `nak` приводит к немедленной переотправке, если не используется `nakWithDelay` для явной задержки. Когда задан `BackOff`, он **полностью переопределяет `AckWait`**. Первое значение BackOff определяет `AckWait`. | 2.7.1   | Yes      |
| ReplayPolicy      | Если политика `ReplayOriginal`, сообщения в потоке будут отправлены клиенту с той же скоростью, с какой они были получены изначально, имитируя исходное время. Если `ReplayInstant` (по умолчанию), сообщения отправляются как можно быстрее с учетом политики подтверждений, Max Ack Pending и способности клиента потреблять сообщения. | 2.2.0   | No       |
| Replicas          | Задает число реплик состояния consumer. По умолчанию при значении 0 consumers наследуют число реплик от потока.                                                                                                                                                                                                                                   | 2.8.3   | Yes      |
| MemoryStorage     | Если задано, состояние consumer хранится в памяти вместо наследования типа хранения потока (по умолчанию хранение на диске). Это снижает I/O от подтверждений, полезно для ephemeral consumers.                                                                                                                                                    | 2.8.3   | No       |
| SampleFrequency   | Задает процент подтверждений, которые следует семплировать для наблюдаемости, 0–100. Значение строковое и допускает `30` и `30%`.                                                                                                                                                                                                               | 2.2.0   | Yes      |
| Metadata          | Набор пар ключ‑значение, определенных приложением, для метаданных consumer.                                                                                                                                                                                                                                                                    | 2.10.0  | Yes      |
| [FilterSubjects](consumers.md#filtersubjects) | Набор subjects, пересекающихся с subjects потока, для фильтрации доставки подписчикам. Примечание: нельзя использовать вместе с `FilterSubject`.                                                                                                                                                                                                    | 2.10.0  | Yes      |
| HeadersOnly       | Доставляет только заголовки сообщений потока, добавляя заголовок `Nats-Msg-Size`, указывающий размер удаленного payload в байтах.                                                                                                                                                                                                                | 2.6.2   | Yes      |

#### AckPolicy

Варианты политики:

* `AckExplicit`: политика по умолчанию. Каждое сообщение должно быть подтверждено. Рекомендуется для максимальной надежности и функциональности.
* `AckNone`: подтверждения не требуются; сервер считает сообщение подтвержденным при доставке.
* `AckAll`: подтверждается только последнее сообщение в серии; все предыдущие сообщения автоматически подтверждаются. Для pull consumer подтверждаются все ожидающие сообщения для всех подписчиков.

Если подтверждение требуется, но не получено в пределах `AckWait`, сообщение будет переотправлено.

> **Warning**: сервер может считать подтверждение пришедшим вне окна. Например, в ситуации с очередью, если первый процесс не подтвердил сообщение вовремя и оно было переотправлено другому consumer, подтверждение от первого consumer будет считаться некорректным.

#### DeliverPolicy

Варианты политики:

* `DeliverAll`: политика по умолчанию. Начать с самого раннего доступного сообщения в потоке.
* `DeliverLast`: начать с последнего сообщения в потоке или последнего сообщения, совпадающего с фильтром consumer, если он задан.
* `DeliverLastPerSubject`: начать с последнего сообщения для каждого фильтруемого subject, находящегося в потоке.
* `DeliverNew`: начать получать сообщения, созданные после создания consumer.
* `DeliverByStartSequence`: начать с первого сообщения с указанным номером последовательности. Consumer должен задать `OptStartSeq`.
* `DeliverByStartTime`: начать с сообщений в заданное время или позже. Consumer должен задать `OptStartTime`.

#### MaxAckPending

`MaxAckPending` обеспечивает контроль потока и применяется как к push, так и к pull consumers. Для push consumers `MaxAckPending` — единственная форма контроля потока. Для pull consumers доставка сообщений по запросу клиента создает неявный контроль потока один‑к‑одному с подписчиками.

Для высокой пропускной способности задайте `MaxAckPending` большим. Для приложений с высокой латентностью из‑за внешних сервисов используйте меньшее значение и настройте `AckWait`, чтобы избежать повторных доставок.

#### FilterSubjects

Filter subject обеспечивает серверную фильтрацию сообщений до доставки клиентам.

Например, поток `factory-events` с subject `factory-events.*.*` может иметь consumer `factory-A` с фильтром `factory-events.A.*`, чтобы доставлять только события фабрики `A`.

Consumer может иметь один `FilterSubject` или несколько `FilterSubjects`. Можно применять несколько фильтров, например `[factory-events.A.*, factory-events.B.*]` или конкретные типы событий `[factory-events.*.item_produced, factory-events.*.item_packaged]`.

> **Warning**: Для точных прав consumers один фильтр использует `$JS.API.CONSUMER.CREATE.{stream}.{consumer}.{filter}` для ограничения пользователей определенными фильтрами. Несколько фильтров используют общий `$JS.API.CONSUMER.DURABLE.CREATE.{stream}.{consumer}`, где отсутствует токен `{filter}`. Для детальных прав используйте другую стратегию.

### Pull‑specific

Эти опции применимы только к pull consumers. Примеры конфигурации см. в [NATS by Example](https://natsbyexample.com/examples/jetstream/pull-consumer/go).

| Field              | Description                                                                                                                                                          | Version | Editable |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- | -------- |
| MaxWaiting         | Максимальное число ожидающих pull‑запросов.                                                                                                                           | 2.2.0   | No       |
| MaxRequestExpires  | Максимальная длительность, в течение которой один pull‑запрос будет ждать доступных сообщений.                                                                          | 2.7.0   | Yes      |
| MaxRequestBatch    | Максимальный размер batch для одного pull‑запроса. Если задано вместе с `MaxRequestMaxBytes`, размер будет ограничен тем лимитом, который достигнут первым.            | 2.7.0   | Yes      |
| MaxRequestMaxBytes | Максимальное количество байтов, которое может быть запрошено в batch. Если задано вместе с `MaxRequestBatch`, размер будет ограничен тем лимитом, который достигнут первым. | 2.8.3   | Yes      |

### Push‑specific

Эти опции применимы только к push consumers. Примеры конфигурации см. в [NATS by Example](https://natsbyexample.com/examples/jetstream/push-consumer/go).

| Field          | Description                                                                                                                                                                                                                                                                                                                                                               | Version | Editable |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- | -------- |
| DeliverSubject | Subject, на который доставляются сообщения. Установка этого поля определяет, является consumer push или pull. При заданном deliver subject сервер будет _push_‑ить сообщения клиентам, подписанным на этот subject.                                                                                                                                                        | 2.2.0   | No       |
| DeliverGroup   | Имя группы очереди для распределения сообщений между подписчиками. Аналог [queue group](https://docs.nats.io/nats-concepts/core-nats/queue) в Core NATS.                                                                                                                                                                                                                  | 2.2.0   | Yes      |
| FlowControl    | Включает контроль потока на подписку с использованием протокола скользящего окна. Этот протокол опирается на обмен сообщениями между сервером и клиентом, чтобы регулировать, когда и сколько сообщений отправлять клиенту. Этот механизм контроля потока один‑к‑одному работает совместно с контролем one‑to‑many через `MaxAckPending` для всех подписок, привязанных к consumer. | 2.2.0   | Yes      |
| IdleHeartbeat  | Если задано, сервер регулярно отправляет статус‑сообщение клиенту в периоды бездействия, показывая, что сервис JetStream доступен. Статус‑сообщение имеет код 100 и не содержит адреса ответа. Примечание: механизм прозрачно обрабатывается поддерживаемыми клиентами.                                                                                                        | 2.2.0   | Yes      |
| RateLimit      | Ограничивает скорость доставки сообщений consumer, в битах в секунду.                                                                                                                                                                                                                                                                                                    | 2.2.0   | Yes      |

---

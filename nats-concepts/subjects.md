# Обмен сообщениями на основе тем

NATS — это система для публикации и получения сообщений в именованных каналах связи, которые мы называем `Subjects`. По своей сути NATS — это `interest-based` система обмена сообщениями, где получатель должен `subscribe` на подмножество `subjects`.

В других middleware‑системах subjects могут называться `topics`, `channels`, `streams` (обратите внимание, что в NATS термин `stream` используется для хранилища сообщений [JetStream](jetstream/README.md)).

**Что такое subject?**  
В самом простом виде subject — это строка символов, образующая имя, по которому издатель и подписчик находят друг друга. Чаще используются [иерархии subjects](#subject-hierarchies), чтобы группировать сообщения в семантические пространства имен.

{% hint style="info" %}
Пожалуйста, ознакомьтесь с [ограничениями и соглашениями](#characters-allowed-and-recommended-for-subject-names) по именованию subjects.
{% endhint %}

**Прозрачность расположения**  
Благодаря адресации на основе subjects NATS обеспечивает прозрачность расположения в (большом) облаке маршрутизируемых серверов NATS.

* Подписки на subjects автоматически распространяются внутри облака серверов.
* Сообщения автоматически маршрутизируются ко всем заинтересованным подписчикам независимо от местоположения.
* Сообщения без подписчиков на их subject автоматически отбрасываются (см. функцию персистентности сообщений в [JetStream](jetstream/README.md)).

![](../.gitbook/assets/subjects1.svg)

## Подстановки

NATS предоставляет два вида подстановочных символов — они могут заменять один или несколько фрагментов subject, разделённых точками. Издатели всегда отправляют сообщение на полностью указанное имя subject без подстановок. Подписчики могут использовать подстановки, чтобы одной подпиской охватить сразу несколько subject-ов.

## Иерархии subjects

Символ `.` создаёт иерархию subject-ов. Например, приложение мировых часов может определить следующую структуру, чтобы логически сгруппировать связанные subject-ы:

```markup
time.us
time.us.east
time.us.east.atlanta
time.eu.east
time.eu.east.warsaw
```

## Рекомендации по использованию subjects

Жесткого ограничения на размер subject нет, но рекомендуется держать число токенов в разумных пределах, например не более 16 токенов и длину subject менее 256 символов.

### Количество subjects

NATS может эффективно управлять десятками миллионов subjects, поэтому вы можете использовать детальную адресацию для своих бизнес‑сущностей. Subjects — это эфемерные ресурсы, которые исчезают, когда на них больше никто не подписан.

При этом подписки на subjects должны кэшироваться сервером в памяти. Учтите, что при увеличении количества подписанных subjects более чем до одного миллиона вам потребуется более 1 ГБ памяти сервера, и дальше рост будет линейным.

### Фильтрация и безопасность на основе subjects

Subject сообщения можно фильтровать разными способами и через разные элементы конфигурации кластера NATS. Например, но не ограничиваясь:

* Безопасность — allow/deny на пользователя
* Импорт/экспорт между аккаунтами
* Автоматические преобразования
* При вставке сообщений в потоки JetStream
* При источниках/зеркалах потоков JetStream
* При подключении leaf nodes (edge‑серверы NATS)
* ...

Хорошо спроектированная иерархия subjects значительно упрощает эти задачи.

### Именование

{% hint style="info" %}
В информатике есть всего две сложные задачи: инвалидация кэша, именование вещей и ошибки на единицу. — неизвестный автор
{% endhint %}

Иерархия subjects — мощный инструмент адресации ресурсов приложения. Поэтому большинство пользователей NATS кодируют бизнес‑семантику в имени subject. Вы свободны выбрать подходящую вам структуру, но в начале проекта стоит избегать излишнего усложнения дизайна subjects.

**Несколько рекомендаций:**

* Используйте первый(ые) токен(ы) для определения общего пространства имен.

````shell
factory1.tools.group42.unit17
````

* Используйте последний(ие) токен(ы) как идентификаторы

````shell
service.deploy.server-acme.app123
````

* Subject _должен_ использоваться более чем для одного сообщения.
* Подписки _должны_ быть стабильными (существовать для получения более одного сообщения).
* По возможности используйте подписки с wildcard вместо подписок на отдельные subjects.
* Именуйте бизнес‑ или физические сущности. Не кодируйте слишком много данных в subject.
* Кодируйте (бизнес)‑намерение в subject, а не технические детали.

Практично:

````shell
orders.online.store123.order171711
````

Возможно, не так полезно:

````shell
orders.online.us.server42.ccpayment.premium.store123.electronics.deliver-dhl.order171711.create
````

* Сообщения NATS поддерживают заголовки. Их можно использовать для дополнительной метадаты. Есть режимы подписки, которые доставляют только заголовки, позволяя эффективно сканировать метаданные в потоке сообщений.

### Соответствие одному токену

Первый wildcard — `*`, он соответствует одному токену. Например, если приложение хочет слушать восточные часовые пояса, оно может подписаться на `time.*.east`, что будет соответствовать `time.us.east` и `time.eu.east`.
Обратите внимание, что `*` не может соответствовать подстроке внутри токена `time.New*.east`.

![](../.gitbook/assets/subjects2.svg)

### Соответствие нескольким токенам

Второй wildcard — `>`, он соответствует одному или нескольким токенам и может появляться только в конце subject. Например, `time.us.>` будет соответствовать `time.us.east` и `time.us.east.atlanta`, тогда как `time.us.*` будет соответствовать только `time.us.east`, поскольку не может соответствовать более чем одному токену.

![](../.gitbook/assets/subjects3.svg)

### Мониторинг и wire taps

В зависимости от настроек безопасности wildcard можно использовать для мониторинга, создавая так называемый _wire tap_. В простейшем случае можно создать подписчика на `>`. Это приложение будет получать все сообщения, отправленные в вашем кластере NATS — разумеется, в пределах настроек безопасности.

### Комбинирование wildcards

Wildcard `*` может встречаться несколько раз в одном subject. Можно использовать оба типа. Например, `*.*.east.>` получит `time.us.east.atlanta`.

## Разрешенные и рекомендуемые символы в именах subjects

Для совместимости между клиентами и удобства поддержки конфигурационных файлов рекомендуется использовать буквенно‑цифровые символы и ASCII‑символы `-` (дефис) и `_` (подчеркивание) в именах subjects и других пользовательских сущностей.

Символы UTF‑8 (UTF8) поддерживаются в subjects. Используйте UTF‑8 на свой риск. Многоязычные имена технических сущностей могут создавать проблемы при редактировании, в конфигурационных файлах, отображении и в международной совместной работе.

Эти правила и рекомендации применяются ко ВСЕМ системным именам: subjects, streams, durables, buckets, keys (в key‑value store), поскольку NATS создаст API‑subjects, содержащие эти имена. NATS будет применять эти ограничения в большинстве случаев, но мы рекомендуем не полагаться на это.

* **Разрешенные символы:** любые Unicode‑символы, кроме `null`, пробела, `.`, `*` и `>`.

* **Рекомендуемые символы:** (`a` - `z`), (`A` - `Z`), (`0` - `9`), `-` и `_` (имена чувствительны к регистру и не могут содержать пробелы).

* **Соглашения об именовании:** если нужно разделять слова, используйте PascalCase, как `MyServiceOrderCreate`, или `-` и `_`, как `my-service-order-create`.

* **Специальные символы:** точка `.` (используется для разделения токенов subject), а также `*` и `>` (используются как wildcards) зарезервированы и не могут использоваться в имени.

* **Зарезервированные имена:** по соглашению subjects, начинающиеся с `$`, зарезервированы для системного использования (например, `$SYS`, `$JS`, `$KV` и т. п.). Многие системные subjects также используют `_` (подчеркивание) (например, _INBOX, KV_ABC, OBJ_XYZ и т. п.).

Хорошие имена

```markup
time.us
time.us2.east1
time.new-york
time.SanFrancisco
```

Устаревшие имена subjects

```markup
location.Malmö
$location.Stockholm
_Subjects_.mysubject
```

Запрещенные имена потоков

```markup
all*data
<my_stream>
service.stream.1
```

### Режим pedantic

По умолчанию, ради эффективности, имена subjects не проверяются при публикации сообщений. В частности, при программной генерации subjects это может приводить к некорректным именам, на которые нельзя подписаться. Например, subjects с wildcards могут быть проигнорированы.

Чтобы включить проверку имен subjects, активируйте режим `pedantic` в параметрах подключения клиента.

```markup
//Java
Options options = Options.builder()
    .server("nats://127.0.0.1:4222")
    .pedantic()
    .build();
Connection nc = Nats.connect(options)
```

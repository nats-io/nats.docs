# NATS 2.2

NATS 2.2 — крупнейший релиз с версии 2.0. Он приносит масштабируемую, производительную, безопасную и простую в использовании потоковую платформу нового поколения JetStream, удалённый доступ по WebSocket, упрощённое управление аккаунтами, нативную поддержку MQTT и продвигает NATS к цели безопасного демократизирования потоков и сервисов для гиперсвязанного мира.

## Стриминг нового поколения

JetStream — это следующая генерация платформы потоков для NATS: высокодоступная, отказоустойчивая и простая в использовании. Мы долго слушали сообщество, анализировали текущие потребности и думали о будущем, чтобы создать JetStream, отвечающий этим требованиям.

JetStream:

* легко разворачивается и управляется, встроен в сервер NATS
* упрощает и ускоряет разработку
* поддерживает wildcard subject-ы
* обеспечивает доставку как минимум один раз и точно один раз в пределах окна
* масштабируется по горизонтали во время работы без остановок
* сохраняет данные в потоках и доставляет или проигрывает через потребителей
* поддерживает несколько шаблонов потребления для одного потока
* поддерживает push и pull режимы при получении сообщений
* осведомлён об аккаунтах
* позволяет задавать гибкие политики безопасности: по потоку, по потребителю, по функции

Начните с [JetStream](../nats-concepts/jetstream/).

## Безопасность и упрощённое управление аккаунтами

Теперь управление аккаунтами стало проще. В NATS встроена система управления аккаунтами, что устраняет необходимость разворачивать отдельный account manager при отказе от memory account resolver. С автоматической генерацией дефолтного системного аккаунта и возможностью предзагрузки аккаунтов достаточно обозначить сервера в кластере как account resolver или cache, и они будут обслуживать публичную информацию об аккаунтах из nsc-утилит. Крупномасштабное управление аккаунтами можно запустить за считанные минуты.

### Ограничения аккаунтов по CIDR-блокам

Задавайте ограничение CIDR-блока для пользователя, чтобы ограничить подключения клиентов из заданного диапазона IP. Это дополнительный уровень безопасности поверх учетных данных: разрешайте подключения только из нужного облака, предприятия, региона или сети.

### Временные ограничения аккаунтов

Теперь можно [указать временной интервал](../using-nats/nats-tools/nsc/basics.md#user-authorization) в течение дня, когда приложения могут подключаться. Например, разрешайте доступ отдельным пользователям или приложениям только в бизнес-часы или защищайте критические операции от пакетных приложений, запускаемых вне нужного времени.

### Дефолтные разрешения пользователей

Можно задавать [дефолтные разрешения пользователей](../running-a-nats-service/configuration/securing_nats/authorization.md#examples) внутри аккаунта. Это упрощает политику, уменьшает вероятность ошибок при выдаче прав и облегчает создание учетных данных.

## WebSockets

Подключайте мобильные и веб-приложения к любому серверу NATS через [WebSockets](../running-a-nats-service/configuration/websocket/). WebSocket-протокол легче проходит сквозь фаерволы и балансировщики, расширяя варианты развертывания NATS и упрощая связь с периферией. Поддерживаются leaf node сервера, nats.ts, nats.deno и клиенты nats.js.

## Нативная поддержка MQTT

С архитектурой [Adaptive Edge](https://nats.io/blog/synadia-adaptive-edge/) и возможностью расширять облачные развертывания на edge логично использовать существующие инвестиции в IoT. Обновление устройств и крупных edge-сетей дорогостоящее, поэтому мы добавили полноценную поддержку [MQTT 3.1.1](../running-a-nats-service/configuration/mqtt/) прямо в сервер NATS.

Интегрируйте IoT-развертывания на MQTT 3.1.1 с облачным NATS, добавьте MQTT-leaf node и мгновенно отправляйте и принимайте сообщения в MQTT-приложениях и устройствах, независимо от того, развернут ли NATS на edge, одном облаке, в нескольких облаках, локально или в любой комбинации.

## Создавайте лучшие системы

Мы добавили функции, повышающие устойчивость, безопасность и общую надёжность системы в масштабе.

### Заголовки сообщений

Добавлена опция использовать заголовки, как в HTTP. Заголовки дают накладные расходы, поэтому мы долго их откладывали. Мы создали внутренние протоколы, видимые разработчикам, сохранив быстрое выполнение простых сообщений, но поддерживая заголовки для тех, кто хочет внедрить метаданные (например, про сжатие или шифрование) без изменения payload. Также доступны специфичные для NATS заголовки для JetStream и других возможностей.

### Плавная техобслуживание с уведомлениями Lame Duck

При отключении сервера для обслуживания можно послать сигнал, активирующий [Lame Duck Mode](../running-a-nats-service/nats_admin/lame_duck_mode.md): сервер больше не принимает новые подключения и постепенно отключает существующие. Клиенты с поддержкой этого режима уведомляют приложения о переходе сервера в состояние отключения, что даёт время плавно перейти на другой сервер или кластер и сохранить непрерывность работы.

### Быстрый отклик при отсутствии ответчиков

Зачем ждать таймаутов, если сервисы недоступны? При вызове request-reply, когда сервер знает, что ответчиков нет, он сразу прерывает запрос, отправляя клиенту сообщение `no-responders`. Это позволяет приложениям мгновенно отреагировать и строить отзывчивые системы даже при отказах сервисов и сетевых разделениях.

### Subject mapping и Traffic Shaping

Минимизируйте риски при выводе новых сервисов. Теперь поддерживаются canary-развертывания, A/B-тесты и прозрачное дублирование потоков. Сервер позволяет аккаунтам создавать маппинги subject-ов для inbound-клиентов и сервисов, а также задавать веса назначения. Можно перенаправлять от 1 до 100% трафика и изменять правила на лету через reload конфигурации. Можно даже отбрасывать часть трафика для chaos-тестирования. Подробности — в [Configuring Subject Mapping and Traffic Shaping](../running-a-nats-service/configuration/configuring_subject_mapping.md).

### Мониторинг аккаунтов — более информативные метрики

NATS теперь поддерживает [тонкий мониторинг](../running-a-nats-service/nats_admin/monitoring/#monitoring-nats) по аккаунтам: можно отслеживать сообщения, байты и другие статистики подключений конкретного аккаунта. Аккаунты могут представлять команды, организации, гео-регионы или роли. Если NATS обеспечивает ваш SaaS, вы можете использовать метрики аккаунтов для биллинга.

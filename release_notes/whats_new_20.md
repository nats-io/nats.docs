# NATS 2.0

NATS 2.0 стал крупнейшим релизом по возможностям с момента появления начальной версии сервера. NATS 2.0 задумывался как способ посмотреть на NATS как на общую службу, которая решает масштабные задачи за счет распределенной безопасности, мультиарендности, больших сетей и безопасного обмена данными.

## Обоснование

NATS 2.0 создавался для решения проблем масштабных распределенных систем.

Сочетать управление идентичностью от начала до конца (или от начала до периферии), совместно с обменом данными, соблюдая политики и требования соответствия — задача непростая. Современные распределенные системы значительно увеличивают сложность операций по мере роста. Возникают трудности с обнаружением служб, подключением, масштабированием под нагрузку, внедрением и обновлениями приложений. Восстановление после аварий становится сложнее, особенно когда системы развиваются в силу технологического разнообразия, а не бизнес-требований. По мере роста сложности системы становятся дорогими в эксплуатации по времени и деньгам. Они становятся хрупкими, усложняя развертывание служб и приложений, тормозя инновации, увеличивая время до получения ценности и совокупную стоимость владения.

Мы решили:

* **Снизить совокупную стоимость владения**: пользователи хотят снизить TCO для своих распределенных систем. Это достигается с помощью простых в использовании технологий, способных работать глобально при минимальной конфигурации и устойчивой облачно-нативной архитектуре.
* **Уменьшить время до получения ценности**: по мере масштабирования систем *время до получения ценности* увеличивается. Операционные команды сопротивляются изменениям из-за риска тронуть сложную и хрупкую систему. Изоляция контекстов позволяет снять часть этих рисков.
* **Поддержать управляемые крупномасштабные развертывания**: никаких силосов данных, формируемых программным обеспечением — всё управляется централизованно и предоставляет бизнесу ровно то, что нужно. Мы хотели обеспечить простую настройку аварийного восстановления.
* **Децентрализовать безопасность**: обеспечить безопасность, охватывающую одну технологию от начала до конца, при которой организации могут настраивать всё самостоятельно, что облегчает поддержку огромного количества конечных точек.

Для этого мы добавили множество новых возможностей, полностью совместимых с существующими клиентами и сохранив 100% обратную совместимость.

## Учетные записи

Accounts (учетные записи) — это безопасные изолированные контексты общения, которые позволяют реализовать мультиарендность в рамках одного развертывания NATS. Учетные записи дают возможность отделить технологию от бизнес-кейсов: силосы данных создаются по проекту, а не по ограничением ПО. При подключении клиент указывает учетную запись или происходит аутентификация по умолчанию с глобальной учетной записью.

Некоторым службам нужно делиться данными за пределами своей учетной записи. Данные можно безопасно передавать между учетными записями через защищенные сервисы и потоки. Поток данных разрешается только при взаимном согласии владельцев учетных записей, а импортирующая учетная запись полностью контролирует свое пространство subject-ов.

Это означает, что внутри учетной записи можно задавать ограничения и использовать subject-ы без опасений столкновений с другими группами или организациями. Группы разработчиков выбирают любые subject-ы, не влияя на остальную систему, и открывают учетные записи только для тех сервисов и потоков, которые действительно нужны.

Учетные записи просты, безопасны и экономичны. Управление одной инсталляцией NATS остается централизованным, но организации и команды разработки получают больше автономии, быстрее достигают результата и используют более гибкие практики.

### Сервисы и потоки

Сервисы и потоки позволяют обмениваться сообщениями между учетными записями.

Рассматривайте сервис как RPC-точку входа в учетную запись. За этой учетной записью может скрываться множество микросервисов, обрабатывающих запросы, но снаружи виден лишь один subject.

**Определения сервисов** открывают точку взаимодействия:

* Экспортировать сервис, чтобы другие учетные записи могли его импортировать.
* Импортировать сервис, чтобы отправлять запросы надежно и прозрачно в другую учетную запись.

Варианты использования включают большинство приложений — всё, что принимает запрос и возвращает ответ.

**Определения потоков** обеспечивают непрерывный поток данных между учетными записями:

* Экспортировать поток, чтобы разрешить исходящий трафик.
* Импортировать поток, чтобы принимать входящий трафик.

Сценарии применения включают observability, метрики и аналитику данных. Любое приложение или конечная точка, которая читает поток данных.

Обратите внимание, что сервисы и потоки работают без изменений в конфигурации клиентов или API. Сервисы могут мигрировать между учетными записями полностью прозрачно для клиентов.

### Системные учетные записи

Системная учетная запись публикует служебные сообщения по установленным шаблонам subject-ов. Это внутренние сообщения NATS, полезные операторам.

События и данные, инициируемые сервером:

* События подключений клиентов
* Статус подключения учетных записей
* Ошибки аутентификации
* События подключений leaf node
* Сводка статистики серверов

Инструменты и клиенты при наличии прав могут запросить:

* Статистику по сервисам
* Обнаружение серверов и метрики

Серверы учетных записей также публикуют сообщения при изменениях учетной записи.

Имея эту информацию и системные метаданные, можно построить полезные инструменты мониторинга и обнаружения аномалий.

## Глобальные развертывания

NATS 2.0 поддерживает глобальные развертывания, позволяя строить топологии, оптимизированные для WAN-сетей и растущие до edge и устройств.

### Самовосстановление

Функции самовосстановления присутствовали в релизах NATS 1.x, и мы сохранили их в глобальных развертываниях. Это включает:

* Автоматическое переподключение клиентов и серверов
* Автообнаружение, при котором серверы обмениваются изменениями топологии между собой и клиентами в реальном времени без дополнительных настроек и простоя. Клиенты могут переключаться на сервера, которые не были им изначально заданы.
* Кластеры серверов NATS автоматически реагируют на появление или удаление серверов, обеспечивая бесшовное обновление и масштабирование.

### Супер-кустеры

Супер-кустеры — это кластеры NATS-кластеров. Создавайте супер-кустеры для построения по-настоящему глобальной сети NATS. Супер-кустеры используют уникальную технологию на основе сплайнов, сохраняют семантику одного хопа и оптимизируют трафик WAN благодаря оптимистичным отправкам и prune-отображению интересов. Супер-кустеры предоставляют прозрачную интеллектуальную поддержку гео-распределенных подписчиков очередей.

### Восстановление после катастроф

Супер-кустеры изначально поддерживают восстановление после катастроф. При гео-распределенных подписчиках очередей предпочтение отдается локальным клиентам, затем RTT используется для поиска кластера с минимальной задержкой и соответствующим подписчиком очереди.

Что это значит?

Допустим, у вас есть набор балансируемых сервисов на восточном побережье США (US-EAST), другой набор в ЕС (EU-WEST) и супер-кустер, состоящий из NATS-кластера в US-EAST, связанного с кластером в EU-WEST. Клиенты из США будут подключаться к US-EAST, а сервисы, связанные с этим кластером, обслуживать их. Клиенты из Европы автоматически используют сервисы в EU-WEST. Если сервисы в US-EAST отключатся, клиенты из США начнут использовать сервисы в EU-WEST.

Когда восточные сервисы снова подключатся к US-EAST, они начнут обслуживать клиентов, находящихся рядом с ними, поскольку находятся в том же кластере. Это происходит автоматически и полностью прозрачно для клиента. Дополнительной конфигурации на серверах NATS не требуется.

Это **восстановление после катастроф без настройки**.

### Leaf node

Leaf node — это сервер NATS, работающий в специализированной конфигурации, позволяющий расширить супер-кустеры топологией хаб-спиц.

Leaf node также позволяют объединить разные домены безопасности, например IoT, мобильные приложения или веб. Они идеально подходят для edge-вычислений, IoT-хабов и дата-центров, которым необходим доступ к глобальному развертыванию NATS. Локальные приложения, общающиеся по loopback-интерфейсу с физическим VM или контейнерной безопасностью, тоже могут использовать leaf node.

Leaf node:

* Прозрачно и безопасно подключаются к удаленной учетной записи NATS
* Безопасно мостят локальные данные в глобальное развертывание NATS
* На 100% прозрачны для клиентов, которые остаются простыми, легковесными и удобными в разработке
* Позволяют использовать локальные схемы безопасности вместе с новыми глобальными функциями защиты NATS
* Могут создавать DMZ между локальным развертыванием NATS и внешним кластером или супер-кустером.

## Децентрализованная безопасность

### Операторы, учетные записи и пользователи

Безопасность NATS 2.0 строится на определении Операторов, Учетных записей и Пользователей в рамках одного развертывания NATS.

* **Оператор** обеспечивает корень доверия в системе, может представлять компанию или предприятие

  * Создает **учетные записи** для администраторов. Учетная запись представляет собой организацию, бизнес-подразделение или сервис с безопасным контекстом внутри развертывания NATS, например группу мониторинга, набор микросервисов или региональное IoT-развертывание. Созданием учетных записей обычно управляет центральная группа.

* **Учетные записи** задают ограничения и могут безопасно экспортировать сервисы и потоки.
  * Менеджеры учетных записей создают **пользователей** с нужными правами.
* **Пользователи** имеют конкретные учетные данные и разрешения.

### Цепочка доверия

PKI (NKeys, закодированные по Ed25519 и подписанные JWT) формируют иерархию Операторов, Учетных записей и Пользователей, создавая масштабируемую и гибкую модель распределенной безопасности.

* **Операторы** представлены самоподписанным JWT и это единственное, что нужно настроить на сервере. Такой JWT обычно подписывается мастер-ключом, хранящимся офлайн. JWT содержит действительные ключи подписи, которые можно отозвать, обновив JWT.

  * Операторы подписывают JWT для **учетных записей** с использованием разных ключей.
  * **Учетные записи** подписывают JWT для **пользователей**, снова применяя разные ключи подписи.

* Клиенты или leaf node предъявляют учетные данные **пользователей** и подписанный nonce при подключении.
  * Сервер с помощью резолверов получает JWT и проверяет цепочку доверия клиента.

Это позволяет оперативно менять права, аутентификацию и ограничения в безопасной мультиарендной системе NATS.
